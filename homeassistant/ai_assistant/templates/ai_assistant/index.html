{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archie - ИИ Ассистент</title>
    
    <!-- React and dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Fixed layout styles */
        .layout-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 40;
            height: 80px;
        }
        
        .sidebar-fixed {
            position: fixed;
            top: 80px;
            left: 0;
            bottom: 80px;
            width: 320px;
            z-index: 30;
            transition: transform 0.3s ease;
        }
        
        .chat-area {
            margin-left: 320px;
            margin-top: 80px;
            margin-bottom: 80px;
            height: calc(100vh - 160px);
            overflow-y: auto;
            transition: margin-left 0.3s ease;
        }
        
        .input-fixed {
            position: fixed;
            bottom: 0;
            left: 320px;
            right: 0;
            z-index: 40;
            height: 80px;
            transition: left 0.3s ease;
        }
        
        /* Sidebar hidden state */
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        
        .chat-area-full {
            margin-left: 0;
        }
        
        .input-full {
            left: 0;
        }
        
        /* Prose styles for message content */
        .prose {
            max-width: none;
        }
        .prose h1, .prose h2, .prose h3 {
            color: inherit;
            margin: 0.5rem 0;
        }
        .prose p {
            margin: 0.5rem 0;
        }
        .prose ul, .prose ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .prose li {
            margin: 0.25rem 0;
        }
        .prose code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
        }
        .prose pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .prose blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            opacity: 0.8;
        }
        .prose a {
            color: #3b82f6;
            text-decoration: none;
        }
        .prose a:hover {
            text-decoration: underline;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar-fixed {
                width: 280px;
                transform: translateX(-100%);
            }
            
            .sidebar-fixed.sidebar-open {
                transform: translateX(0);
            }
            
            .chat-area {
                margin-left: 0;
            }
            
            .input-fixed {
                left: 0;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-neutral-950">
    <div id="chat-root"></div>

    <script type="text/babel">
        {% verbatim %}
        const { useState, useRef, useEffect } = React;

        // Simple SVG Icons as React components
        const SendIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
            </svg>
        );

        const MenuIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );

        const SearchIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="M21 21l-4.35-4.35"></path>
            </svg>
        );

        const PlusIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const WifiIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                <line x1="12" y1="20" x2="12.01" y2="20"></line>
            </svg>
        );

        const ArrowLeftIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12,19 5,12 12,5"></polyline>
            </svg>
        );

        const UserIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const BotIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="11" width="18" height="10" rx="2" ry="2"></rect>
                <circle cx="12" cy="5" r="2"></circle>
                <path d="M12 7v4"></path>
                <line x1="8" y1="16" x2="8" y2="16"></line>
                <line x1="16" y1="16" x2="16" y2="16"></line>
            </svg>
        );

        const CopyIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        const QuoteIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"></path>
                <path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"></path>
            </svg>
        );

        const MessageCircleIcon = () => (
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" opacity="0.3">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        );

        // Weather Icons
        const SunIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        );

        const CloudIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
            </svg>
        );

        const RainIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="16" y1="13" x2="16" y2="21"></line>
                <line x1="8" y1="13" x2="8" y2="21"></line>
                <line x1="12" y1="15" x2="12" y2="23"></line>
                <path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path>
            </svg>
        );

        const SnowIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"></path>
                <line x1="8" y1="16" x2="8.01" y2="16"></line>
                <line x1="8" y1="20" x2="8.01" y2="20"></line>
                <line x1="12" y1="18" x2="12.01" y2="18"></line>
                <line x1="12" y1="22" x2="12.01" y2="22"></line>
                <line x1="16" y1="16" x2="16.01" y2="16"></line>
                <line x1="16" y1="20" x2="16.01" y2="20"></line>
            </svg>
        );

        const ThermometerIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"></path>
            </svg>
        );

        const DropletIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
            </svg>
        );

        const WindIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"></path>
                <path d="M9.6 4.6A2 2 0 1 1 11 8H2"></path>
                <path d="M12.6 19.4A2 2 0 1 0 14 16H2"></path>
            </svg>
        );

        const EyeIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        );

        const CompassIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polygon points="16.24,7.76 14.12,14.12 7.76,16.24 9.88,9.88 16.24,7.76"></polygon>
            </svg>
        );

        const SunriseIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 18a5 5 0 0 0-10 0"></path>
                <line x1="12" y1="2" x2="12" y2="9"></line>
                <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
                <line x1="1" y1="18" x2="3" y2="18"></line>
                <line x1="21" y1="18" x2="23" y2="18"></line>
                <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
                <line x1="23" y1="22" x2="1" y2="22"></line>
                <polyline points="8,6 12,2 16,6"></polyline>
            </svg>
        );

        const SunsetIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 18a5 5 0 0 0-10 0"></path>
                <line x1="12" y1="9" x2="12" y2="2"></line>
                <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
                <line x1="1" y1="18" x2="3" y2="18"></line>
                <line x1="21" y1="18" x2="23" y2="18"></line>
                <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
                <line x1="23" y1="22" x2="1" y2="22"></line>
                <polyline points="16,5 12,9 8,5"></polyline>
            </svg>
        );

        // Weather utility functions
        const getWeatherIcon = (condition) => {
            switch (condition?.main?.toLowerCase()) {
                case 'clear': return React.createElement(SunIcon);
                case 'clouds': return React.createElement(CloudIcon);
                case 'rain':
                case 'drizzle': return React.createElement(RainIcon);
                case 'snow': return React.createElement(SnowIcon);
                case 'thunderstorm': return React.createElement(RainIcon);
                default: return React.createElement(CloudIcon);
            }
        };

        const formatTemperature = (temp) => `${Math.round(temp)}°C`;

        const getWindDirection = (degrees) => {
            const directions = ['С', 'ССВ', 'СВ', 'ВСВ', 'В', 'ВЮВ', 'ЮВ', 'ЮЮВ', 'Ю', 'ЮЮЗ', 'ЮЗ', 'ЗЮЗ', 'З', 'ЗСЗ', 'СЗ', 'ССЗ'];
            return directions[Math.round(degrees / 22.5) % 16];
        };

        // API Class for handling backend communication
        class ChatAPI {
            constructor() {
                this.baseUrl = '/ai-assistant/api';
            }

            async getConversations() {
                const response = await fetch(`${this.baseUrl}/conversations/`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }

            async createConversation() {
                const response = await fetch(`${this.baseUrl}/conversations/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: `Новый чат ${Date.now()}` })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }

            async getMessages(conversationId) {
                const response = await fetch(`${this.baseUrl}/conversations/${conversationId}/messages/`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }

            async sendMessage(messageData) {
                const response = await fetch(`${this.baseUrl}/messages/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageData)
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }
        }

        const ChatAssistant = () => {
            const [conversations, setConversations] = useState([]);
            const [currentConversation, setCurrentConversation] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [error, setError] = useState(null);
            
            const messagesEndRef = useRef(null);
            const api = useRef(new ChatAPI());

            useEffect(() => {
                loadConversations();
            }, []);

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const loadConversations = async () => {
                try {
                    const convos = await api.current.getConversations();
                    setConversations(convos);
                } catch (err) {
                    setError(`Не удалось загрузить чаты: ${err.message}`);
                }
            };

            const selectConversation = async (conversationId) => {
                setCurrentConversation(conversationId);
                
                // Если это временный чат, просто очищаем сообщения
                if (conversationId.startsWith('temp-')) {
                    setMessages([]);
                    return;
                }
                
                try {
                    const msgs = await api.current.getMessages(conversationId);
                    setMessages(msgs);
                } catch (err) {
                    setError(`Не удалось загрузить сообщения: ${err.message}`);
                }
            };

            const createNewChat = () => {
                // Создаем временный чат без запроса к серверу
                const tempChatId = `temp-${Date.now()}`;
                const tempConvo = {
                    conversation_id: tempChatId,
                    title: 'Новый чат',
                    created_at: new Date().toISOString(),
                    is_temp: true // Флаг временного чата
                };
                
                setConversations(prev => [tempConvo, ...prev]);
                setCurrentConversation(tempChatId);
                setMessages([]);
            };

            const sendMessage = async () => {
                if (!inputValue.trim() || !currentConversation || isLoading) return;

                const messageText = inputValue;
                const userMessage = {
                    message_id: `temp-user-${Date.now()}`,
                    role: 'user',
                    text: messageText,
                    text_format: 'html',
                    created_at: new Date().toISOString()
                };

                setMessages(prev => [...prev, userMessage]);
                setInputValue('');
                setIsLoading(true);

                try {
                    let conversationId = currentConversation;
                    
                    // Если это временный чат, сначала создаем реальную беседу
                    if (currentConversation.startsWith('temp-')) {
                        const newConvo = await api.current.createConversation();
                        conversationId = newConvo.conversation_id;
                        
                        // Обновляем список чатов - заменяем временный на реальный
                        setConversations(prev => prev.map(conv => 
                            conv.conversation_id === currentConversation 
                                ? { ...newConvo, title: `Новый чат ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}` }
                                : conv
                        ));
                        setCurrentConversation(conversationId);
                    }

                    const result = await api.current.sendMessage({
                        role: 'user',
                        text: messageText,
                        text_format: 'html',
                        conversation_id: conversationId
                    });

                    const assistantMessage = {
                        message_id: result.message_id || `temp-assistant-${Date.now()}`,
                        role: 'assistant',
                        text: result.text,
                        text_format: result.text_format,
                        created_at: result.created_at || new Date().toISOString(),
                        metadata: result.metadata
                    };

                    setMessages(prev => [...prev, assistantMessage]);
                } catch (err) {
                    setError(`Не удалось отправить сообщение: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const executeCommand = async (command, assistantRequest) => {
                if (!currentConversation) return;

                const messageText = assistantRequest || command;
                setIsLoading(true);

                try {
                    let conversationId = currentConversation;
                    
                    // Если это временный чат, сначала создаем реальную беседу
                    if (currentConversation.startsWith('temp-')) {
                        const newConvo = await api.current.createConversation();
                        conversationId = newConvo.conversation_id;
                        
                        // Обновляем список чатов - заменяем временный на реальный
                        setConversations(prev => prev.map(conv => 
                            conv.conversation_id === currentConversation 
                                ? { ...newConvo, title: `Новый чат ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}` }
                                : conv
                        ));
                        setCurrentConversation(conversationId);
                    }

                    const result = await api.current.sendMessage({
                        role: 'user',
                        text: messageText,
                        text_format: 'html',
                        conversation_id: conversationId
                    });

                    const assistantMessage = {
                        message_id: result.message_id || `temp-assistant-${Date.now()}`,
                        role: 'assistant',
                        text: result.text,
                        text_format: result.text_format,
                        created_at: result.created_at || new Date().toISOString(),
                        metadata: result.metadata
                    };

                    setMessages(prev => [...prev, assistantMessage]);
                } catch (err) {
                    setError(`Ошибка выполнения команды: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const testAPI = async () => {
                try {
                    const convos = await api.current.getConversations();
                    alert(`✅ API работает! Найдено ${convos.length} чатов.`);
                } catch (err) {
                    alert(`❌ Ошибка API: ${err.message}`);
                }
            };

            const testWeatherWidget = () => {
                // Создаем тестовое сообщение с погодным виджетом
                const testWeatherMessage = {
                    message_id: `test-weather-${Date.now()}`,
                    role: 'assistant',
                    text: 'Вот текущая погода в вашем регионе:',
                    text_format: 'html',
                    created_at: new Date().toISOString(),
                    metadata: {
                        weather_widget: {
                            location: 'Bad Mergentheim, Germany',
                            current_weather: {
                                temperature: 15.5,
                                feels_like: 13.2,
                                humidity: 78,
                                pressure: 1013,
                                wind_speed: 3.2,
                                wind_direction: 245,
                                visibility: 10000,
                                cloud_cover: 40,
                                condition: {
                                    main: 'Clouds',
                                    description: 'переменная облачность',
                                    icon: '02d'
                                },
                                is_day: true
                            },
                            today: {
                                sunrise: '07:45',
                                sunset: '18:32',
                                temperature_min: 8.1,
                                temperature_max: 17.3,
                                precipitation_total_mm: 2.1
                            },
                            forecast: [
                                {
                                    date: '2025-10-06',
                                    time: '15:00',
                                    temperature: 16.0,
                                    temperature_min: 14.0,
                                    temperature_max: 18.0,
                                    precipitation_chance: 20,
                                    condition: {
                                        main: 'Clear',
                                        description: 'ясно'
                                    }
                                },
                                {
                                    date: '2025-10-06',
                                    time: '18:00',
                                    temperature: 14.5,
                                    temperature_min: 12.0,
                                    temperature_max: 16.0,
                                    precipitation_chance: 10,
                                    condition: {
                                        main: 'Clouds',
                                        description: 'облачно'
                                    }
                                },
                                {
                                    date: '2025-10-07',
                                    time: '09:00',
                                    temperature: 11.2,
                                    temperature_min: 9.0,
                                    temperature_max: 13.0,
                                    precipitation_chance: 60,
                                    condition: {
                                        main: 'Rain',
                                        description: 'небольшой дождь'
                                    }
                                }
                            ],
                            last_updated: new Date().toISOString(),
                            data_source: 'OpenWeather'
                        }
                    }
                };

                // Если нет активного чата, создаем временный
                if (!currentConversation) {
                    createNewChat();
                }

                // Добавляем тестовое сообщение
                setMessages(prev => [...prev, testWeatherMessage]);
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text);
            };

            const formatTime = (dateString) => {
                return new Date(dateString).toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            };

            const filteredConversations = conversations.filter(conv =>
                conv.title.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const renderMessage = (message) => {
                const isUser = message.role === 'user';
                
                return React.createElement('div', {
                    key: message.message_id,
                    className: `mb-6 flex ${isUser ? 'justify-end' : 'justify-start'}`
                }, React.createElement('div', {
                    className: `max-w-[70%] ${isUser ? 'order-2' : 'order-1'}`
                }, [
                    React.createElement('div', {
                        key: 'bubble',
                        className: `backdrop-blur-lg rounded-3xl p-6 border shadow-2xl relative group transition-all duration-300 hover:scale-[1.02] ${
                            isUser 
                                ? 'bg-gradient-to-r from-slate-600 to-slate-700 border-slate-500/30 text-white' 
                                : 'bg-white/10 border-white/20 text-white'
                        }`
                    }, [
                        React.createElement('div', {
                            key: 'header',
                            className: 'flex items-center gap-2 mb-3'
                        }, [
                            isUser ? React.createElement(UserIcon, { key: 'icon' }) : React.createElement(BotIcon, { key: 'icon' }),
                            React.createElement('span', {
                                key: 'name',
                                className: 'text-sm opacity-70'
                            }, isUser ? 'Вы' : 'Archie'),
                            React.createElement('span', {
                                key: 'time',
                                className: 'text-xs opacity-50 ml-auto'
                            }, formatTime(message.created_at))
                        ]),
                        React.createElement('div', {
                            key: 'content',
                            className: 'prose prose-invert max-w-none',
                            dangerouslySetInnerHTML: { __html: message.text }
                        }),
                        React.createElement('button', {
                            key: 'copy',
                            onClick: () => copyToClipboard(message.text),
                            className: 'absolute top-4 right-4 p-2 rounded-full bg-black/20 hover:bg-black/40 transition-all opacity-0 group-hover:opacity-100 hover:scale-110'
                        }, React.createElement(CopyIcon))
                    ]),
                    message.metadata ? React.createElement('div', {
                        key: 'metadata-wrapper'
                    }, renderMetadata(message.metadata)) : null
                ].filter(Boolean)));
            };

            const renderMetadata = (metadata) => {
                if (!metadata) return null;

                const elements = [];

                // UI Buttons
                if (metadata.ui_elements?.length > 0) {
                    elements.push(React.createElement('div', {
                        key: 'ui-buttons',
                        className: 'flex flex-wrap gap-2'
                    }, metadata.ui_elements.map((button, index) => 
                        React.createElement('button', {
                            key: index,
                            onClick: () => executeCommand(button.command || button.label, button.assistant_request),
                            className: 'px-4 py-2 rounded-full backdrop-blur-md bg-white/10 border border-white/20 text-white hover:bg-white/20 transition-all duration-300 hover:scale-105 active:scale-95 shadow-lg hover:shadow-white/30'
                        }, button.label)
                    )));
                }

                // Cards
                if (metadata.cards?.length > 0) {
                    elements.push(React.createElement('div', {
                        key: 'cards',
                        className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'
                    }, metadata.cards.map((card, index) => 
                        React.createElement('div', {
                            key: index,
                            className: 'backdrop-blur-lg bg-white/10 rounded-2xl p-4 border border-white/20 shadow-xl hover:shadow-slate-500/30 transition-all duration-300 hover:scale-105 group relative'
                        }, [
                            React.createElement('h3', {
                                key: 'title',
                                className: 'font-semibold text-white mb-2'
                            }, card.title),
                            card.subtitle ? React.createElement('p', {
                                key: 'subtitle',
                                className: 'text-sm text-white/70 mb-2'
                            }, card.subtitle) : null,
                            React.createElement('div', {
                                key: 'content',
                                className: 'text-white/80 text-sm prose prose-invert',
                                dangerouslySetInnerHTML: { __html: card.text }
                            }),
                            React.createElement('button', {
                                key: 'copy',
                                onClick: () => copyToClipboard(card.text),
                                className: 'absolute top-2 right-2 p-1 rounded-full bg-black/20 hover:bg-black/40 transition-all opacity-0 group-hover:opacity-100'
                            }, React.createElement(CopyIcon))
                        ])
                    )));
                }

                // Navigation Card
                if (metadata.navigation_card) {
                    elements.push(React.createElement('div', {
                        key: 'nav-card',
                        className: 'backdrop-blur-lg bg-amber-600/20 rounded-2xl p-4 border border-amber-600/30 shadow-xl hover:shadow-amber-500/30 transition-all duration-300'
                    }, [
                        React.createElement('h3', {
                            key: 'title',
                            className: 'font-semibold text-amber-200 mb-2'
                        }, metadata.navigation_card.title),
                        metadata.navigation_card.description ? React.createElement('p', {
                            key: 'desc',
                            className: 'text-white/80 mb-3'
                        }, metadata.navigation_card.description) : null,
                        React.createElement('div', {
                            key: 'buttons',
                            className: 'flex flex-wrap gap-2'
                        }, metadata.navigation_card.buttons?.map((button, index) =>
                            React.createElement('button', {
                                key: index,
                                onClick: () => executeCommand(button.command || button.label, button.assistant_request),
                                className: 'px-3 py-2 rounded-full backdrop-blur-md bg-amber-600/20 border border-amber-600/30 text-amber-200 hover:bg-amber-600/40 transition-all duration-300 hover:scale-105 shadow-lg hover:shadow-amber-500/50'
                            }, button.label)
                        ))
                    ]));
                }

                // Weather Widget
                if (metadata.weather_widget) {
                    const weather = metadata.weather_widget;
                    elements.push(React.createElement('div', {
                        key: 'weather-widget',
                        className: 'backdrop-blur-lg bg-gradient-to-br from-sky-600/20 to-blue-600/20 rounded-2xl p-6 border border-sky-600/30 shadow-xl hover:shadow-sky-500/30 transition-all duration-300'
                    }, [
                        // Header
                        React.createElement('div', {
                            key: 'header',
                            className: 'flex items-center justify-between mb-4'
                        }, [
                            React.createElement('h3', {
                                key: 'title',
                                className: 'font-bold text-sky-200 text-xl'
                            }, '🌤️ Погода'),
                            React.createElement('div', {
                                key: 'location',
                                className: 'text-white/70 text-sm'
                            }, weather.location)
                        ]),

                        // Current Weather
                        React.createElement('div', {
                            key: 'current',
                            className: 'bg-white/5 rounded-xl p-4 mb-4'
                        }, [
                            React.createElement('div', {
                                key: 'current-main',
                                className: 'flex items-center justify-between mb-3'
                            }, [
                                React.createElement('div', {
                                    key: 'temp-container',
                                    className: 'flex items-center gap-3'
                                }, [
                                    getWeatherIcon(weather.current_weather.condition),
                                    React.createElement('div', {
                                        key: 'temp-info'
                                    }, [
                                        React.createElement('div', {
                                            key: 'temperature',
                                            className: 'text-3xl font-bold text-white'
                                        }, formatTemperature(weather.current_weather.temperature)),
                                        React.createElement('div', {
                                            key: 'description',
                                            className: 'text-white/70 text-sm capitalize'
                                        }, weather.current_weather.condition.description)
                                    ])
                                ]),
                                React.createElement('div', {
                                    key: 'feels-like',
                                    className: 'text-right'
                                }, [
                                    React.createElement('div', {
                                        key: 'feels-label',
                                        className: 'text-white/50 text-xs'
                                    }, 'Ощущается'),
                                    React.createElement('div', {
                                        key: 'feels-temp',
                                        className: 'text-white font-semibold'
                                    }, formatTemperature(weather.current_weather.feels_like))
                                ])
                            ]),

                            // Weather Details Grid
                            React.createElement('div', {
                                key: 'details',
                                className: 'grid grid-cols-2 md:grid-cols-4 gap-3 text-sm'
                            }, [
                                // Humidity
                                React.createElement('div', {
                                    key: 'humidity',
                                    className: 'flex items-center gap-2 bg-white/5 rounded-lg p-2'
                                }, [
                                    React.createElement(DropletIcon),
                                    React.createElement('div', {
                                        key: 'hum-data'
                                    }, [
                                        React.createElement('div', {
                                            key: 'hum-label',
                                            className: 'text-white/50 text-xs'
                                        }, 'Влажность'),
                                        React.createElement('div', {
                                            key: 'hum-value',
                                            className: 'text-white font-medium'
                                        }, `${weather.current_weather.humidity}%`)
                                    ])
                                ]),

                                // Wind
                                React.createElement('div', {
                                    key: 'wind',
                                    className: 'flex items-center gap-2 bg-white/5 rounded-lg p-2'
                                }, [
                                    React.createElement(WindIcon),
                                    React.createElement('div', {
                                        key: 'wind-data'
                                    }, [
                                        React.createElement('div', {
                                            key: 'wind-label',
                                            className: 'text-white/50 text-xs'
                                        }, 'Ветер'),
                                        React.createElement('div', {
                                            key: 'wind-value',
                                            className: 'text-white font-medium'
                                        }, `${Math.round(weather.current_weather.wind_speed * 3.6)} км/ч ${weather.current_weather.wind_direction ? getWindDirection(weather.current_weather.wind_direction) : ''}`)
                                    ])
                                ]),

                                // Pressure
                                React.createElement('div', {
                                    key: 'pressure',
                                    className: 'flex items-center gap-2 bg-white/5 rounded-lg p-2'
                                }, [
                                    React.createElement(CompassIcon),
                                    React.createElement('div', {
                                        key: 'pressure-data'
                                    }, [
                                        React.createElement('div', {
                                            key: 'pressure-label',
                                            className: 'text-white/50 text-xs'
                                        }, 'Давление'),
                                        React.createElement('div', {
                                            key: 'pressure-value',
                                            className: 'text-white font-medium'
                                        }, `${weather.current_weather.pressure} мм`)
                                    ])
                                ]),

                                // Visibility
                                weather.current_weather.visibility ? React.createElement('div', {
                                    key: 'visibility',
                                    className: 'flex items-center gap-2 bg-white/5 rounded-lg p-2'
                                }, [
                                    React.createElement(EyeIcon),
                                    React.createElement('div', {
                                        key: 'vis-data'
                                    }, [
                                        React.createElement('div', {
                                            key: 'vis-label',
                                            className: 'text-white/50 text-xs'
                                        }, 'Видимость'),
                                        React.createElement('div', {
                                            key: 'vis-value',
                                            className: 'text-white font-medium'
                                        }, `${Math.round(weather.current_weather.visibility / 1000)} км`)
                                    ])
                                ]) : null
                            ])
                        ]),

                        // Today's Summary
                        weather.today ? React.createElement('div', {
                            key: 'today',
                            className: 'bg-white/5 rounded-xl p-4 mb-4'
                        }, [
                            React.createElement('h4', {
                                key: 'today-title',
                                className: 'font-semibold text-white mb-3'
                            }, 'Сегодня'),
                            React.createElement('div', {
                                key: 'today-grid',
                                className: 'grid grid-cols-2 md:grid-cols-4 gap-3 text-sm'
                            }, [
                                // Min/Max Temp
                                (weather.today.temperature_min !== null && weather.today.temperature_max !== null) ? React.createElement('div', {
                                    key: 'minmax',
                                    className: 'flex items-center gap-2'
                                }, [
                                    React.createElement(ThermometerIcon),
                                    React.createElement('div', {
                                        key: 'minmax-data'
                                    }, [
                                        React.createElement('div', {
                                            key: 'minmax-label',
                                            className: 'text-white/50 text-xs'
                                        }, 'Мин/Макс'),
                                        React.createElement('div', {
                                            key: 'minmax-value',
                                            className: 'text-white font-medium'
                                        }, `${formatTemperature(weather.today.temperature_min)} / ${formatTemperature(weather.today.temperature_max)}`)
                                    ])
                                ]) : null,

                                // Sunrise
                                weather.today.sunrise ? React.createElement('div', {
                                    key: 'sunrise',
                                    className: 'flex items-center gap-2'
                                }, [
                                    React.createElement(SunriseIcon),
                                    React.createElement('div', {
                                        key: 'sunrise-data'
                                    }, [
                                        React.createElement('div', {
                                            key: 'sunrise-label',
                                            className: 'text-white/50 text-xs'
                                        }, 'Восход'),
                                        React.createElement('div', {
                                            key: 'sunrise-value',
                                            className: 'text-white font-medium'
                                        }, weather.today.sunrise)
                                    ])
                                ]) : null,

                                // Sunset
                                weather.today.sunset ? React.createElement('div', {
                                    key: 'sunset',
                                    className: 'flex items-center gap-2'
                                }, [
                                    React.createElement(SunsetIcon),
                                    React.createElement('div', {
                                        key: 'sunset-data'
                                    }, [
                                        React.createElement('div', {
                                            key: 'sunset-label',
                                            className: 'text-white/50 text-xs'
                                        }, 'Закат'),
                                        React.createElement('div', {
                                            key: 'sunset-value',
                                            className: 'text-white font-medium'
                                        }, weather.today.sunset)
                                    ])
                                ]) : null,

                                // Precipitation
                                weather.today.precipitation_total_mm ? React.createElement('div', {
                                    key: 'precipitation',
                                    className: 'flex items-center gap-2'
                                }, [
                                    React.createElement(RainIcon),
                                    React.createElement('div', {
                                        key: 'precip-data'
                                    }, [
                                        React.createElement('div', {
                                            key: 'precip-label',
                                            className: 'text-white/50 text-xs'
                                        }, 'Осадки'),
                                        React.createElement('div', {
                                            key: 'precip-value',
                                            className: 'text-white font-medium'
                                        }, `${weather.today.precipitation_total_mm} мм`)
                                    ])
                                ]) : null
                            ])
                        ]) : null,

                        // Forecast
                        weather.forecast && weather.forecast.length > 0 ? React.createElement('div', {
                            key: 'forecast',
                            className: 'bg-white/5 rounded-xl p-4'
                        }, [
                            React.createElement('h4', {
                                key: 'forecast-title',
                                className: 'font-semibold text-white mb-3'
                            }, 'Прогноз'),
                            React.createElement('div', {
                                key: 'forecast-list',
                                className: 'space-y-2'
                            }, weather.forecast.slice(0, 5).map((forecast, index) => 
                                React.createElement('div', {
                                    key: index,
                                    className: 'flex items-center justify-between py-2 px-3 bg-white/5 rounded-lg hover:bg-white/10 transition-all duration-200'
                                }, [
                                    React.createElement('div', {
                                        key: 'forecast-time',
                                        className: 'flex items-center gap-3'
                                    }, [
                                        getWeatherIcon(forecast.condition),
                                        React.createElement('div', {
                                            key: 'time-info'
                                        }, [
                                            React.createElement('div', {
                                                key: 'time',
                                                className: 'text-white font-medium text-sm'
                                            }, `${forecast.date} ${forecast.time}`),
                                            React.createElement('div', {
                                                key: 'condition',
                                                className: 'text-white/60 text-xs capitalize'
                                            }, forecast.condition.description)
                                        ])
                                    ]),
                                    React.createElement('div', {
                                        key: 'forecast-temp',
                                        className: 'flex items-center gap-3'
                                    }, [
                                        forecast.precipitation_chance ? React.createElement('div', {
                                            key: 'rain-chance',
                                            className: 'text-sky-300 text-xs flex items-center gap-1'
                                        }, [
                                            React.createElement(DropletIcon),
                                            `${forecast.precipitation_chance}%`
                                        ]) : null,
                                        React.createElement('div', {
                                            key: 'temp',
                                            className: 'text-white font-semibold'
                                        }, `${formatTemperature(forecast.temperature_min)} / ${formatTemperature(forecast.temperature_max)}`)
                                    ])
                                ])
                            ))
                        ]) : null,

                        // Footer
                        React.createElement('div', {
                            key: 'footer',
                            className: 'flex items-center justify-between mt-4 pt-3 border-t border-white/10 text-xs text-white/50'
                        }, [
                            React.createElement('span', {
                                key: 'source'
                            }, weather.data_source || 'Источник: OpenWeather'),
                            React.createElement('span', {
                                key: 'updated'
                            }, `Обновлено: ${new Date(weather.last_updated).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`)
                        ])
                    ]));
                }

                return elements.length > 0 ? React.createElement('div', {
                    className: 'mt-4 space-y-4'
                }, elements) : null;
            };

            const sidebarClasses = `sidebar-fixed backdrop-blur-md bg-white/10 border-r border-white/20 shadow-2xl flex flex-col ${
                !isSidebarOpen ? 'sidebar-hidden' : ''
            }`;

            const chatAreaClasses = `chat-area p-6 ${!isSidebarOpen ? 'chat-area-full' : ''}`;
            const inputAreaClasses = `input-fixed p-4 border-t border-white/20 backdrop-blur-md bg-white/5 flex items-center gap-3 ${
                !isSidebarOpen ? 'input-full' : ''
            }`;

            return React.createElement('div', {
                className: 'layout-container'
            }, [
                // Fixed Header
                React.createElement('header', {
                    key: 'header',
                    className: 'header-fixed backdrop-blur-md bg-white/10 border-b border-white/20 p-4 shadow-2xl flex items-center justify-between'
                }, [
                    React.createElement('div', {
                        key: 'header-left',
                        className: 'flex items-center gap-4'
                    }, [
                        React.createElement('button', {
                            key: 'menu-btn',
                            onClick: () => setIsSidebarOpen(!isSidebarOpen),
                            className: 'p-3 rounded-xl bg-gradient-to-r from-slate-700 to-slate-600 hover:from-slate-600 hover:to-slate-500 transition-all duration-300 hover:scale-110 shadow-lg active:scale-95'
                        }, React.createElement(MenuIcon)),
                        React.createElement('h1', {
                            key: 'title',
                            className: 'text-2xl font-bold text-white'
                        }, 'Archie AI')
                    ]),
                    React.createElement('div', {
                        key: 'header-right',
                        className: 'flex items-center gap-3'
                    }, [
                        React.createElement('button', {
                            key: 'test-btn',
                            onClick: testAPI,
                            className: 'px-4 py-2 rounded-full bg-red-600 hover:bg-red-500 text-white transition-all duration-300 hover:scale-105 flex items-center gap-2 shadow-lg hover:shadow-red-500/50'
                        }, [React.createElement(WifiIcon, { key: 'wifi-icon' }), 'Тест API']),
                        React.createElement('button', {
                            key: 'weather-test',
                            onClick: () => testWeatherWidget(),
                            className: 'px-4 py-2 rounded-full bg-sky-600 hover:bg-sky-500 text-white transition-all duration-300 hover:scale-105 flex items-center gap-2 shadow-lg hover:shadow-sky-500/50'
                        }, ['🌤️', 'Тест Погоды']),
                        React.createElement('button', {
                            key: 'home-btn',
                            onClick: () => window.location.href = '/',
                            className: 'px-4 py-2 rounded-full bg-white/10 backdrop-blur-md border border-white/20 hover:bg-white/20 text-white transition-all duration-300 hover:scale-105 flex items-center gap-2 shadow-lg hover:shadow-white/30'
                        }, [React.createElement(ArrowLeftIcon, { key: 'arrow-icon' }), 'Главная'])
                    ])
                ]),

                // Fixed Sidebar
                React.createElement('div', {
                    key: 'sidebar',
                    className: sidebarClasses
                }, [
                    React.createElement('div', {
                        key: 'sidebar-header',
                        className: 'p-4 border-b border-white/20'
                    }, [
                        React.createElement('h2', {
                            key: 'sidebar-title',
                            className: 'text-xl font-bold text-white mb-4'
                        }, 'Чаты'),
                        React.createElement('button', {
                            key: 'new-chat-btn',
                            onClick: createNewChat,
                            className: 'w-full mb-4 px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-500 hover:to-emerald-600 rounded-full font-semibold text-white transition-all duration-300 hover:scale-105 flex items-center justify-center gap-2 shadow-lg hover:shadow-emerald-500/50'
                        }, [React.createElement(PlusIcon, { key: 'plus-icon' }), 'Новый чат']),
                        React.createElement('div', {
                            key: 'search-container',
                            className: 'relative'
                        }, [
                            React.createElement('div', {
                                key: 'search-icon',
                                className: 'absolute left-3 top-3.5 text-white/60 pointer-events-none'
                            }, React.createElement(SearchIcon)),
                            React.createElement('input', {
                                key: 'search-input',
                                type: 'text',
                                placeholder: 'Поиск по чатам...',
                                value: searchQuery,
                                onChange: (e) => setSearchQuery(e.target.value),
                                className: 'w-full pl-10 pr-4 py-3 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-all'
                            })
                        ])
                    ]),
                    React.createElement('div', {
                        key: 'chat-list',
                        className: 'flex-1 overflow-y-auto p-2'
                    }, filteredConversations.map((conversation) =>
                        React.createElement('button', {
                            key: conversation.conversation_id,
                            onClick: () => selectConversation(conversation.conversation_id),
                            className: `w-full p-4 mb-2 rounded-2xl text-left transition-all duration-300 hover:scale-105 ${
                                currentConversation === conversation.conversation_id
                                    ? 'bg-gradient-to-r from-slate-600 to-slate-700 text-white shadow-lg'
                                    : 'bg-white/5 hover:bg-white/10 text-white/80 hover:text-white'
                            } ${conversation.is_temp ? 'border-2 border-dashed border-amber-500/50' : ''}`
                        }, [
                            React.createElement('div', {
                                key: 'title',
                                className: 'font-medium truncate flex items-center gap-2'
                            }, [
                                conversation.title,
                                conversation.is_temp ? React.createElement('span', {
                                    key: 'temp-badge',
                                    className: 'text-xs bg-amber-500/20 text-amber-300 px-2 py-1 rounded-full'
                                }, 'не сохранен') : null
                            ]),
                            React.createElement('div', {
                                key: 'date',
                                className: 'text-sm opacity-60 mt-1'
                            }, conversation.is_temp ? 'Новый чат' : new Date(conversation.created_at).toLocaleDateString('ru-RU'))
                        ])
                    ))
                ]),

                // Scrollable Chat Area
                React.createElement('div', {
                    key: 'chat-area',
                    className: chatAreaClasses
                }, currentConversation ? [
                    messages.length === 0 ? React.createElement('div', {
                        key: 'empty-state',
                        className: 'flex items-center justify-center h-full'
                    }, React.createElement('div', {
                        className: 'text-center text-white/60'
                    }, [
                        React.createElement(MessageCircleIcon, { key: 'icon' }),
                        React.createElement('p', {
                            key: 'text',
                            className: 'text-lg mt-4'
                        }, 'Начните разговор с Archie')
                    ])) : React.createElement('div', {
                        key: 'messages'
                    }, [
                        ...messages.map(renderMessage),
                        isLoading ? React.createElement('div', {
                            key: 'typing',
                            className: 'flex justify-start mb-6'
                        }, React.createElement('div', {
                            className: 'backdrop-blur-lg bg-white/10 rounded-3xl p-6 border border-white/20'
                        }, [
                            React.createElement('div', {
                                key: 'typing-header',
                                className: 'flex items-center gap-2'
                            }, [
                                React.createElement(BotIcon, { key: 'bot-icon' }),
                                React.createElement('span', {
                                    key: 'typing-text',
                                    className: 'text-sm opacity-70'
                                }, 'Archie печатает')
                            ]),
                            React.createElement('div', {
                                key: 'typing-dots',
                                className: 'flex gap-1 mt-3'
                            }, [
                                React.createElement('div', {
                                    key: 'dot1',
                                    className: 'w-2 h-2 bg-white/60 rounded-full animate-pulse'
                                }),
                                React.createElement('div', {
                                    key: 'dot2',
                                    className: 'w-2 h-2 bg-white/60 rounded-full animate-pulse',
                                    style: { animationDelay: '0.2s' }
                                }),
                                React.createElement('div', {
                                    key: 'dot3',
                                    className: 'w-2 h-2 bg-white/60 rounded-full animate-pulse',
                                    style: { animationDelay: '0.4s' }
                                })
                            ])
                        ])) : null,
                        React.createElement('div', {
                            key: 'messages-end',
                            ref: messagesEndRef
                        })
                    ])
                ] : React.createElement('div', {
                    key: 'welcome',
                    className: 'flex items-center justify-center h-full'
                }, React.createElement('div', {
                    className: 'text-center text-white/60'
                }, [
                    React.createElement(MessageCircleIcon, { key: 'icon' }),
                    React.createElement('h2', {
                        key: 'title',
                        className: 'text-2xl font-bold mb-2 mt-6'
                    }, 'Добро пожаловать в Archie'),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: 'text-lg mb-6'
                    }, 'Выберите чат или создайте новый для начала разговора'),
                    React.createElement('button', {
                        key: 'create-btn',
                        onClick: createNewChat,
                        className: 'px-6 py-3 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 rounded-full font-semibold text-white transition-all duration-300 hover:scale-105 flex items-center gap-2 mx-auto shadow-lg hover:shadow-slate-500/50'
                    }, [React.createElement(PlusIcon, { key: 'plus' }), 'Создать новый чат'])
                ]))),

                // Fixed Input Area
                React.createElement('div', {
                    key: 'input-area',
                    className: inputAreaClasses
                }, [
                    React.createElement('div', {
                        key: 'input-container',
                        className: 'flex-1 relative'
                    }, React.createElement('input', {
                        type: 'text',
                        value: inputValue,
                        onChange: (e) => setInputValue(e.target.value),
                        onKeyPress: (e) => e.key === 'Enter' && sendMessage(),
                        placeholder: 'Напишите сообщение...',
                        disabled: isLoading,
                        className: 'w-full px-6 py-4 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-all'
                    })),
                    React.createElement('button', {
                        key: 'quote-btn',
                        disabled: !currentConversation,
                        className: 'p-4 rounded-full bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-600 disabled:opacity-50 text-white transition-all duration-300 hover:scale-110 active:scale-95 shadow-lg hover:shadow-emerald-500/50'
                    }, React.createElement(QuoteIcon)),
                    React.createElement('button', {
                        key: 'send-btn',
                        onClick: sendMessage,
                        disabled: !inputValue.trim() || isLoading || !currentConversation,
                        className: 'p-4 rounded-full bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 disabled:from-slate-700 disabled:to-slate-800 disabled:opacity-50 text-white transition-all duration-300 hover:scale-110 active:scale-95 shadow-lg hover:shadow-slate-500/50'
                    }, React.createElement(SendIcon))
                ]),

                // Error Toast
                error ? React.createElement('div', {
                    key: 'error',
                    className: 'fixed bottom-4 right-4 bg-red-600 text-white px-6 py-3 rounded-full shadow-lg backdrop-blur-md animate-pulse z-50'
                }, [
                    error,
                    React.createElement('button', {
                        key: 'close',
                        onClick: () => setError(null),
                        className: 'ml-3 text-white/80 hover:text-white transition-all'
                    }, '×')
                ]) : null
            ]);
        };

        // Render the component using React 18 createRoot API
        const container = document.getElementById('chat-root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(ChatAssistant));
        {% endverbatim %}
    </script>
</body>
</html>

{% load static %}

<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tablet Dashboard</title>
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css"
        rel="stylesheet">
    <style>
        :root {
            --screen-width: 1024px; /* фикс целевой */
            --screen-height: 600px; /* фикс целевой */
            --tile-gap: 10px; /* было 12 */
            --tile-columns: 2;
            --tile-rows: 4;
            --base-font: 15px;
            --scale: 1; /* динамическое масштабирование содержимого info-panel */
            --tile-scale: 1; /* динамический масштаб плиток */
        }

        html,
        body {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        body {
            font-size: var(--base-font);
            background-color: #121212;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-container {
            height: 100vh;
            max-width: var(--screen-width);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            height: 100vh;
        }

        .button-panel {
            background-color: #1e1e1e;
            border-right: 1px solid #333;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: var(--tile-gap);
            width: 40%;
        }

        .info-panel {
            background-color: #1e1e1e;
            padding: 10px 14px 8px;
            width: 60%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .info-content {
            flex-grow: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }



        .btn-tile {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #252525;
            border: 2px solid;
            color: #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.85rem; /* чуть меньше */
            min-height: 0; /* убрать фикс минимум */
        }

        .btn-tile:hover {
            background-color: #333;
            transform: scale(1.05);
        }

        .btn-tile:active,
        .btn-tile.touch-active {
            filter: brightness(1.3);
            transform: scale(1.04);
        }

        .btn-light {
            border-color: #f8f9fa;
        }

        .btn-light i {
            color: #f8f9fa;
        }

        .btn-music {
            border-color: #8e44ad;
        }

        .btn-music i {
            color: #8e44ad;
        }

        .btn-docs {
            border-color: #f39c12;
        }

        .btn-docs i {
            color: #f39c12;
        }

        .btn-camera {
            border-color: #e74c3c;
        }

        .btn-camera i {
            color: #e74c3c;
        }

        .btn-climate {
            border-color: #3498db;
        }

        .btn-climate i {
            color: #3498db;
        }

        .btn-media {
            border-color: #2ecc71;
        }

        .btn-media i {
            color: #2ecc71;
        }

        .btn-security {
            border-color: #d35400;
        }

        .btn-security i {
            color: #d35400;
        }

        .btn-settings {
            border-color: #7f8c8d;
        }

        .btn-settings i {
            color: #7f8c8d;
        }

        .btn-tile i {
            font-size: calc(2.2rem * var(--tile-scale));
            margin-bottom: 4px;
        }

        .button-panel .btn-tile span {
            font-size: calc(0.85rem * var(--tile-scale));
            line-height: 1.1;
        }

        #datetime {
            font-size: calc(1.4rem * var(--scale));
            margin-bottom: calc(10px * var(--scale));
            color: #e0e0e0;
            line-height: 1.1;
        }



        @media (orientation: portrait) {
            /* fallback если повернули устройство */
            .main-content {
                flex-direction: column;
            }

            .button-panel {
                width: 100%;
                grid-template-columns: repeat(4, 1fr);
                grid-auto-rows: 110px;
            }

            .info-panel {
                width: 100%;
                flex: 1;
            }
        }

        /* Скрыть скроллбар но оставить прокрутку */
        .info-panel::-webkit-scrollbar {
            width: 6px;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .image-container, .abstract-image { display:none; }

        .weather-card, .calendar-card { padding: 8px 10px; background:#1a1a1a; border:1px solid #2a2a2a; border-radius:10px; }
        .weather-row { margin-bottom: 10px; }
        .weather-card h6 { font-size: calc(0.9rem * var(--scale)); margin-bottom: 6px; color: #e0e0e0; }
        .weather-card .d-flex, .calendar-card .d-flex { align-items: flex-start; }
        .calendar-card h5 { font-size: calc(1rem * var(--scale)); margin-bottom: 8px; }
        .calendar-card .list-group-item { padding: 6px 0; font-size: calc(0.85rem * var(--scale)); border-color: #2a2a2a !important; }
        .calendar-card h6 { font-size: calc(0.85rem * var(--scale)); margin: 0 0 2px; }
        .calendar-card small { font-size: calc(0.7rem * var(--scale)); }

        .chat-assistant-container {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="main-content">
            <!-- Левая панель с кнопками 2x4 -->
            <div class="button-panel">
                <button class="btn-tile btn-light" onclick="window.location.href='/light/'">
                    <i class="bi bi-lightbulb"></i>
                    <span>Свет</span>
                </button>
                <button class="btn-tile btn-music" id="music-btn" data-api="/api/music">
                    <i class="bi bi-music-note-beamed"></i>
                    <span>Музыка</span>
                </button>
                <button class="btn-tile btn-docs" id="docs-btn" data-api="/api/docs">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>Документы</span>
                </button>
                <button class="btn-tile btn-camera" onclick="window.location.href='/camera/'">
                    <i class="bi bi-camera"></i>
                    <span>Камера</span>
                </button>
                <button class="btn-tile btn-climate" onclick="window.location.href='/weather/'">
                    <i class="bi bi-thermometer-half"></i>
                    <span>Климат</span>
                </button>
                <button class="btn-tile btn-media" onclick="window.location.href='/ai-assistant/'">
                    <i class="bi bi-robot"></i>
                    <span>Archie</span>
                </button>
                <button class="btn-tile btn-security" data-api="/api/security">
                    <i class="bi bi-shield-lock"></i>
                    <span>Безопасность</span>
                </button>
                <button class="btn-tile btn-settings" data-api="/api/settings">
                    <i class="bi bi-gear"></i>
                    <span>Настройки</span>
                </button>
            </div>

            <!-- Правая панель с чат-ассистентом -->
            <div class="info-panel">
                <div class="info-content">
                    <div id="datetime" class="text-center"></div>
                    
                    <!-- Встроенный чат-ассистент -->
                    <div class="chat-assistant-container">
                        <iframe 
                            src="/ai-assistant/" 
                            frameborder="0" 
                            style="width: 100%; height: calc(100vh - 200px); border-radius: 10px; background: #1e1e1e;"
                            sandbox="allow-same-origin allow-scripts allow-forms"
                            loading="lazy">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Обновление даты и времени
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('ru-RU', options);
        }

        // Обновление времени при загрузке и каждую минуту
        updateDateTime();
        setInterval(updateDateTime, 60000);

        // Функция для отправки API-запросов на бэкенд
        async function sendApiRequest(endpoint, action = 'toggle') {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: action })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API request failed:', error);
                // Для демонстрации сейчас показываем alert, но в реальном приложении
                // лучше показать уведомление на странице
                alert(`API запрос к ${endpoint} не выполнен: ${error.message}`);
                return null;
            }
        }

        // Получение погодных данных
        async function fetchWeatherData() {
            // В реальном приложении здесь будет запрос к API бэкенда
            // Сейчас используем заглушку
            console.log('Запрос погодных данных с бэкенда...');
            // Имитация запроса к API
            // await sendApiRequest('/api/weather/current');
        }

        // Получение данных календаря
        async function fetchCalendarEvents() {
            // В реальном приложении здесь будет запрос к API бэкенда
            console.log('Запрос событий календаря с бэкенда...');
            // Имитация запроса к API
            // await sendApiRequest('/api/calendar/today');
        }

        // Получение абстрактного изображения
        async function fetchAbstractImage() {
            // В реальном приложении здесь будет запрос к API бэкенда
            console.log('Запрос абстрактного изображения с бэкенда...');
            // Имитация запроса к API, в реальном приложении раскомментировать и заменить на реальный путь:
            // document.getElementById('abstractImagePlaceholder').src = '/api/abstract-image';
        }

        // Обработчики для всех кнопок
        document.querySelectorAll('.btn-tile').forEach(button => {
            button.addEventListener('click', async function () {
                const apiEndpoint = this.getAttribute('data-api');
                if (apiEndpoint) {
                    console.log(`Отправка запроса на ${apiEndpoint}`);
                    // Для демонстрации сейчас используем alert
                    alert(`Отправка запроса на ${apiEndpoint}`);
                    // В реальном приложении раскомментировать:
                    // const response = await sendApiRequest(apiEndpoint);
                    // if (response) {
                    //     console.log('Получен ответ:', response);
                    //     // Обработка ответа
                    // }
                }
            });
        });



        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function () {
            fetchWeatherData();
            fetchCalendarEvents();
            fetchAbstractImage();
            console.log('Страница готова к работе с Python бэкендом');
        });

        function adjustLayout() {
            const vh = window.innerHeight; // реальная высота
            const main = document.querySelector('.main-content');
            const buttonPanel = document.querySelector('.button-panel');
            if (!main || !buttonPanel) return;
            const available = vh;
            main.style.height = available + 'px';
            // Расчёт высоты строк сетки для равномерного заполнения
            const rows = parseInt(getComputedStyle(buttonPanel).getPropertyValue('--tile-rows')) || 4;
            const gap = parseInt(getComputedStyle(buttonPanel).gap) || 10;
            const paddingY = 24; // top+bottom padding (approx)
            let rowHeight = Math.floor((available - paddingY - gap * (rows - 1)) / rows);
            if (rowHeight < 70) rowHeight = 70; // минимально допустимое
            buttonPanel.style.gridAutoRows = rowHeight + 'px';
            // Масштаб иконок и текста на плитках относительно базовых 100px
            const base = 100;
            const scale = Math.min(1, Math.max(0.72, rowHeight / base));
            document.documentElement.style.setProperty('--tile-scale', scale.toFixed(2));
        }
        window.addEventListener('resize', () => { adjustLayout(); packInfoPanel(); });
        document.addEventListener('DOMContentLoaded', () => { adjustLayout(); packInfoPanel(); });
        function packInfoPanel() {
            const infoPanel = document.querySelector('.info-panel');
            if (!infoPanel) return;
            const rootStyle = document.documentElement.style;
            let scale = 1.0;
            const minScale = 0.7;
            rootStyle.setProperty('--scale', scale.toString());
            // цикл уменьшает масштаб пока всё не влезет без вертикальной прокрутки или пока не достигнут предел
            // (используем scrollHeight после применения стиля)
            while (scale > minScale && infoPanel.scrollHeight > infoPanel.clientHeight + 2) {
                scale -= 0.05;
                rootStyle.setProperty('--scale', scale.toFixed(2));
            }
        }
        // Тактильная подсветка
        document.addEventListener('pointerdown', e => {
            const t = e.target.closest('.btn-tile');
            if (t) t.classList.add('touch-active');
        });
        document.addEventListener('pointerup', () => {
            document.querySelectorAll('.btn-tile.touch-active').forEach(b => b.classList.remove('touch-active'));
        });
        document.addEventListener('pointercancel', () => {
            document.querySelectorAll('.btn-tile.touch-active').forEach(b => b.classList.remove('touch-active'));
        });
    </script>
</body>

</html>
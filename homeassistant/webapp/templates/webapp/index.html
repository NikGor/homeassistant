{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archie AI Home</title>
    
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Подключение библиотеки иконок Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Подключение шрифта Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- React and dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <style>
        body, html {
            font-family: 'Inter', sans-serif;
            height: 100%;
            overflow: hidden; /* Предотвращаем прокрутку body */
            background: #000;
        }
        
        /* Стили для кастомной полосы прокрутки */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 3px;
        }
        
        /* Анимация пульсации для шара */
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 25px 4px rgba(0, 191, 255, 0.4);
                transform: translate(-50%, -50%) scale(0.98);
            }
            50% {
                box-shadow: 0 0 50px 15px rgba(0, 191, 255, 0.7);
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .orb {
            width: min(60vw, 60vh, 500px); /* Адаптивный размер: 60% от меньшей стороны экрана, максимум 500px */
            height: min(60vw, 60vh, 500px);
            background: #050505;
            border-radius: 50%;
            animation: pulse 4s infinite ease-in-out;
            box-shadow: 0 0 25px 4px rgba(0, 191, 255, 0.4);
            position: fixed; /* Фиксируем относительно viewport */
            top: 50%;
            left: 50%;
            z-index: 1; /* Убеждаемся что он под контентом */
        }
        
        /* Стили для "Матового стекла" */
        .frosted-glass-card {
            background-color: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 191, 255, 0.25);
            border-radius: 0.75rem;
            padding: 1.25rem;
        }
        
        .glass-tile {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease;
        }
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Стили для всплывающих подсказок */
        .device-wrapper {
            position: relative;
            display: inline-block;
        }
        .device-tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            position: absolute;
            z-index: 50;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .device-wrapper:hover .device-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Стили для боковых панелей (сайдбаров) */
        .sidebar {
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0.75rem; /* 12px */
            transition: all 0.3s ease-in-out;
            z-index: 40;
        }
        
        /* Стили для кнопок в сайдбарах */
        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 56px; /* 14 * 4 */
            width: 56px; /* 14 * 4 */
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .sidebar-item.active {
            background: rgba(0, 191, 255, 0.2);
            color: #00bfff; /* DeepSkyBlue */
        }
        .sidebar-item:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }
        .sidebar-item:disabled:hover {
            background: transparent;
        }
        
        /* Стили для развернутых кнопок */
        .sidebar-item-expanded {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 1rem; /* 16px */
            height: 48px; /* 12 * 4 */
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .sidebar-item-expanded:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .sidebar-item-expanded.active {
            background: rgba(0, 191, 255, 0.2);
            color: #00bfff;
        }
        .sidebar-text {
            opacity: 0;
            transition: opacity 0.2s ease 0.1s;
        }
        
        /* Контейнер для основного контента */
        #main-content-area {
            position: relative;
            flex: 1;
            height: 100%;
            overflow: hidden; /* Важно: скрываем overflow здесь */
            z-index: 10;
            transition: all 0.3s ease-in-out;
        }

        /* Оба "экрана" (Чат и Дашборд) */
        .view-screen {
            position: absolute;
            inset: 0;
            overflow-y: auto; /* Прокрутка *внутри* каждого экрана */
            padding: 1rem; /* Отступы для прокрутки */
        }

        /* AI Assistant integration styles */
        #chat-assistant-root {
            /* Remove default padding from view-screen for full AI Assistant control */
            margin: -1rem;
            height: calc(100% + 2rem);
        }

        /* Override AI Assistant styles to match glassmorphism theme */
        #chat-assistant-root .backdrop-blur-lg {
            background: rgba(255, 255, 255, 0.07) !important;
            border: 1px solid rgba(0, 191, 255, 0.25) !important;
        }

        #chat-assistant-root .bg-white\/10 {
            background: rgba(255, 255, 255, 0.07) !important;
        }

        /* Ensure scrollbars match the theme */
        #chat-assistant-root ::-webkit-scrollbar {
            width: 6px;
        }
        #chat-assistant-root ::-webkit-scrollbar-track {
            background: transparent;
        }
        #chat-assistant-root ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 3px;
        }

        /* Простые стили для чатов */
        .chat-item {
            padding: 8px 12px;
            margin: 2px 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Responsive dashboard grid styles */
        .dashboard-grid-landscape {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 1.5rem;
            aspect-ratio: 3/2;
            height: calc(100vh - 200px); /* Подстраиваем под доступную высоту */
        }

        .dashboard-grid-portrait {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 1.5rem;
            aspect-ratio: 2/3;
            height: calc(100vh - 200px); /* Подстраиваем под доступную высоту */
        }

        .dashboard-tile {
            aspect-ratio: 1; /* Квадратные плитки */
            min-height: 0; /* Позволяем сжиматься */
        }

        /* Стили для планшетных альбомных разрешений */
        @media (max-height: 720px) and (orientation: landscape) {
            .dashboard-compact {
                height: calc(100vh - 80px) !important; /* Увеличиваем отступы для гармонии */
            }
            
            .dashboard-tiles-compact {
                gap: 1rem !important; /* Увеличиваем отступы между плитками */
                margin-bottom: 1rem !important;
            }
            
            .dashboard-tile-compact {
                padding: 1rem !important; /* Комфортные внутренние отступы */
                font-size: 0.875rem !important; /* Читаемый размер шрифта */
                max-height: 280px !important; /* Ограничиваем высоту для планшетов */
            }
            
            .dashboard-tile-compact h2 {
                font-size: 1rem !important; /* Увеличиваем заголовки */
                margin-bottom: 0.25rem !important;
                line-height: 1.25 !important;
            }
            
            .dashboard-tile-compact p {
                font-size: 0.75rem !important; /* Читаемые подзаголовки */
                line-height: 1.25 !important;
            }
            
            .dashboard-tile-compact .device-icon {
                width: 1.5rem !important; /* Увеличиваем иконки устройств */
                height: 1.5rem !important;
            }
            
            .dashboard-tile-compact i {
                width: 1.25rem !important; /* Читаемые иконки */
                height: 1.25rem !important;
            }
            
            .quick-actions-compact {
                gap: 0.75rem !important; /* Комфортные отступы между кнопками */
                margin-bottom: 1rem !important;
                height: 56px !important; /* Фиксированная высота для кнопок */
            }
            
            .quick-action-btn-compact {
                padding: 0.75rem 1.5rem !important; /* Крупные кнопки (large) */
                font-size: 0.875rem !important;
                font-weight: 500 !important;
                height: 56px !important; /* Фиксированная высота */
            }
            
            .quick-action-btn-compact i {
                width: 1.125rem !important;
                height: 1.125rem !important;
            }
            
            /* Комфортные отступы */
            .view-screen {
                padding: 1rem !important;
            }
        }

        /* Экстремальная оптимизация для очень низких экранов (600px и меньше) */
        @media (max-height: 600px) and (orientation: landscape) {
            .dashboard-compact {
                height: calc(100vh - 32px) !important; /* Точный расчет */
            }
            
            .dashboard-tiles-compact {
                gap: 0.75rem !important; /* 12px зазоры */
                margin-bottom: 1rem !important; /* 16px под кнопки */
                max-height: calc(100vh - 92px) !important; /* 600 - 32 (отступы) - 60 (кнопки) = 508px */
            }
            
            .dashboard-tile-compact {
                aspect-ratio: 1 !important; /* Строго квадратные */
                padding: 0.5rem !important; /* 8px внутренние отступы */
                max-height: 240px !important; /* Точный размер плитки */
                min-height: 240px !important; /* Фиксированная высота */
            }
            
            .dashboard-tile-compact h2 {
                font-size: 0.75rem !important; /* 12px заголовки */
                line-height: 1rem !important;
                margin-bottom: 0.125rem !important; /* 2px */
            }
            
            .dashboard-tile-compact p {
                font-size: 0.625rem !important; /* 10px подзаголовки */
                line-height: 0.75rem !important;
            }
            
            .dashboard-tile-compact .device-icon {
                width: 0.875rem !important; /* 14px иконки устройств */
                height: 0.875rem !important;
            }
            
            .dashboard-tile-compact i {
                width: 0.875rem !important; /* 14px все иконки */
                height: 0.875rem !important;
            }
            
            .quick-actions-compact {
                gap: 0.5rem !important; /* 8px зазоры между кнопками */
                margin-bottom: 0 !important; /* Убираем лишние отступы */
                height: 44px !important; /* Фиксированная высота для кнопок */
            }
            
            .quick-action-btn-compact {
                padding: 0.375rem 0.75rem !important; /* 6px/12px компактные кнопки */
                font-size: 0.75rem !important; /* 12px текст */
                font-weight: 500 !important;
                height: 44px !important; /* Фиксированная высота */
            }
            
            .quick-action-btn-compact i {
                width: 0.875rem !important; /* 14px иконки кнопок */
                height: 0.875rem !important;
            }
            
            /* Точные отступы */
            .view-screen {
                padding: 1rem !important; /* 16px отступы */
            }
        }

    </style>
</head>
<body class="bg-black text-gray-300 h-screen overflow-hidden flex">

    <!-- Анимированный фоновый элемент (дышащий круг) -->
    <div class="orb"></div>

    <!-- 
      ЛЕВАЯ БОКОВАЯ ПАНЕЛЬ ("Арчи")
    -->
    <nav id="left-sidebar" class="sidebar" style="border-right: 1px solid rgba(255, 255, 255, 0.1);">
        <!-- Верхняя группа: Приложения "Арчи" -->
        <div class="flex-1 flex flex-col">
            <!-- Контейнер для свернутых иконок -->
            <div id="left-sidebar-collapsed-icons" class="flex-1 flex flex-col">
                <!-- Будет заполняться JS -->
            </div>
            
            <!-- Контейнер для развернутого меню -->
            <div id="left-sidebar-expanded-menu" class="hidden flex-1 flex flex-col">
                <!-- Будет заполняться JS -->
            </div>
        </div>

        <!-- Нижняя группа: Свернуть/Развернуть -->
        <div class="space-y-3">
            <button id="left-sidebar-toggle-btn" class="sidebar-item text-gray-400 w-14 h-14" title="Развернуть панель">
                <!-- Иконка будет меняться JS -->
            </button>
        </div>
    </nav>

    <!-- 
      ОСНОВНАЯ ОБЛАСТЬ КОНТЕНТА
      (Содержит переключаемые экраны)
    -->
    <main id="main-content-area">
        <!-- 
          ЭКРАН 1: ЧАТ АРЧИ (z-10)
        -->
        <div id="chat-view" class="view-screen z-10">
            <!-- AI Assistant will be rendered here by React -->
            <div id="chat-assistant-root" class="h-full w-full"></div>
        </div>

        <!-- 
          ЭКРАН 2: ДАШБОРД УМНОГО ДОМА (z-10, скрыт)
        -->
        <div id="dashboard-view" class="view-screen z-10 hidden">
            <div class="w-full lg:max-w-none lg:h-full lg:flex lg:items-center lg:justify-center">
                <div class="lg:w-auto">
                    <div id="dashboard-tiles" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6">
                        <!-- Плитки будут генерироваться здесь JS -->
                    </div>

                    <div id="global-quick-actions" class="flex flex-wrap gap-3">
                        <!-- Кнопки будут генерироваться здесь JS -->
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <!-- 
      ПРАВАЯ БОКОВАЯ ПАНЕЛЬ ("Дом")
    -->
    <nav id="right-sidebar" class="sidebar" style="border-left: 1px solid rgba(255, 255, 255, 0.1);">
        <!-- Верхняя группа: Приложения "Дома" -->
        <div>
            <!-- Контейнер для свернутых иконок -->
            <div id="right-sidebar-collapsed-icons" class="space-y-3">
                <!-- Сюда JS добавит иконки "Главная", "Archie" и приложения -->
            </div>
            
            <!-- Контейнер для развернутого меню -->
            <div id="right-sidebar-expanded-menu" class="hidden space-y-2">
                <!-- Сюда JS добавит пункты меню "Главная", "Archie" и приложения -->
            </div>
        </div>

        <!-- Нижняя группа: Свернуть/Развернуть -->
        <div class="space-y-3">
            <button id="right-sidebar-toggle-btn" class="sidebar-item text-gray-400 w-14 h-14" title="Развернуть панель">
                <!-- Иконка будет меняться JS -->
            </button>
        </div>
    </nav>


    <script>
        // Данные из JSON для дашборда
        const dashboardData = {
            "type": "tool_call",
            "voice_response": "Создаю атмосферу джазового бара: приглушаю свет и запускаю джазовую музыку.",
            "smarthome_dashboard": {
                "type": "smarthome_dashboard",
                "tiles": [
                    { "category": "light", "title": "Свет", "subtitle": "2 из 3 включены, тёплый белый", "icon": "lightbulb", "status_color": "orange", "quick_actions": ["Выключить все", "Приглушить свет"], "devices": [{ "name": "Торшер комната 1", "icon": "lamp", "color": "orange", "variant": "outline", "tooltip": "Выкл., 80%, 3000K" }, { "name": "Потолочная комната 1", "icon": "lightbulb", "color": "orange", "variant": "solid", "tooltip": "Вкл., 60%, 4000K" }, { "name": "Спальня", "icon": "bed", "color": "yellow", "variant": "solid", "tooltip": "Вкл., 40%, 2700K" }] },
                    { "category": "climate", "title": "Климат", "subtitle": "Средняя 21.8°C, обогрев активен", "icon": "thermometer", "status_color": "orange", "quick_actions": ["Эко режим", "Снизить температуру"], "devices": [{ "name": "Регулятор комната 1", "icon": "flame", "color": "orange", "variant": "solid", "tooltip": "22.5°C→23.0°C, 45%, обогрев" }, { "name": "Регулятор комната 2", "icon": "thermometer", "color": "green", "variant": "outline", "tooltip": "21.0°C→21.5°C, 48%, выкл." }] },
                    { "category": "music", "title": "Музыка", "subtitle": "Не играет", "icon": "music", "status_color": "gray", "quick_actions": ["Джаз плейлист", "Последний трек"], "devices": null },
                    { "category": "documents", "title": "Документы", "subtitle": "Поиск готов", "icon": "file-search", "status_color": "blue", "quick_actions": ["Найти документ", "Архив"], "devices": null },
                    { "category": "apps", "title": "Приложения", "subtitle": "Все системы в норме", "icon": "grid-3x3", "status_color": "green", "quick_actions": ["Перезагрузить", "Логи"], "devices": null },
                    { "category": "settings", "title": "Настройки", "subtitle": "Конфигурация", "icon": "settings", "status_color": "gray", "quick_actions": ["Открыть настройки", "Профиль"], "devices": null }
                ],
                "quick_actions": [
                    { "type": "assistant_button", "text": "Джазовая атмосфера", "style": "primary", "icon": "music", "assistant_request": "Создать атмосферу джазового бара" },
                    { "type": "assistant_button", "text": "Выключить свет", "style": "secondary", "icon": "lightbulb-off", "assistant_request": "Выключить весь свет" }
                ]
            }
        };

        // --- Глобальные переменные состояния ---
        let isLeftSidebarExpanded = false;
        let isRightSidebarExpanded = false;

        // --- Получение ссылок на DOM-элементы ---
        
        // --- Левая панель ---
        const leftSidebar = document.getElementById('left-sidebar');
        const leftSidebarCollapsedIcons = document.getElementById('left-sidebar-collapsed-icons');
        const leftSidebarExpandedMenu = document.getElementById('left-sidebar-expanded-menu');
        const leftSidebarToggleBtn = document.getElementById('left-sidebar-toggle-btn');
        
        // --- Правая панель ---
        const rightSidebar = document.getElementById('right-sidebar');
        const rightSidebarCollapsedIcons = document.getElementById('right-sidebar-collapsed-icons');
        const rightSidebarExpandedMenu = document.getElementById('right-sidebar-expanded-menu');
        const rightSidebarToggleBtn = document.getElementById('right-sidebar-toggle-btn');
        
        // --- Контент ---
        const mainContentArea = document.getElementById('main-content-area');
        const chatView = document.getElementById('chat-view');
        const dashboardView = document.getElementById('dashboard-view');
        
        // --- Элементы Дашборда ---
        const globalQuickActionsContainer = document.getElementById('global-quick-actions');
        const dashboardTilesContainer = document.getElementById('dashboard-tiles');

        // --- Вспомогательные функции ---

        // (getTailwindColorClass и getTailwindBgColorClass)
        function getTailwindColorClass(colorName, shade = 400) {
            const colorMap = { "gray": "gray", "green": "green", "blue": "blue", "orange": "orange", "yellow": "yellow", "red": "red", "purple": "purple" };
            return `text-${colorMap[colorName] || 'gray'}-${shade}`;
        }
        function getTailwindBgColorClass(colorName, shade = 600, opacity = 20) {
            const colorMap = { "gray": "gray", "green": "green", "blue": "blue", "orange": "orange", "yellow": "yellow", "red": "red", "purple": "purple" };
            return `bg-${colorMap[colorName] || 'gray'}-${shade}/${opacity}`;
        }

        // --- Функции рендеринга ---

        // Рендеринг ЛЕВОЙ боковой панели ("Арчи")
        function renderLeftSidebar() {
            leftSidebarCollapsedIcons.innerHTML = '';
            leftSidebarExpandedMenu.innerHTML = '';

            // Кнопка "Новый чат"
            const newChatCollapsed = document.createElement('a');
            newChatCollapsed.href = "#";
            newChatCollapsed.className = "sidebar-item text-gray-300";
            newChatCollapsed.title = "Новый чат";
            newChatCollapsed.onclick = (e) => {
                e.preventDefault();
                // Простое создание нового чата через API
                fetch('/ai-assistant/api/conversations/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                }).then(response => response.json())
                  .then(newChat => {
                      console.log('New chat created:', newChat);
                      loadChats(); // Перезагрузить список
                      if (window.chatAssistantAPI) {
                          window.chatAssistantAPI.selectConversation(newChat.conversation_id);
                      }
                  }).catch(error => console.error('Error creating chat:', error));
            };
            newChatCollapsed.innerHTML = `<i data-lucide="plus-circle" class="w-6 h-6"></i>`;
            leftSidebarCollapsedIcons.appendChild(newChatCollapsed);

            // Кнопка "Предыдущее сообщение" (только в свернутом виде)
            const prevMessageBtn = document.createElement('button');
            prevMessageBtn.id = 'prev-message-btn';
            prevMessageBtn.className = "sidebar-item text-gray-400";
            prevMessageBtn.title = "Предыдущее сообщение";
            prevMessageBtn.onclick = () => {
                if (window.chatAssistantAPI) {
                    window.chatAssistantAPI.navigateMessages('prev');
                }
            };
            prevMessageBtn.innerHTML = `<i data-lucide="chevron-up" class="w-6 h-6"></i>`;
            leftSidebarCollapsedIcons.appendChild(prevMessageBtn);

            // Кнопка "Следующее сообщение" (только в свернутом виде)
            const nextMessageBtn = document.createElement('button');
            nextMessageBtn.id = 'next-message-btn';
            nextMessageBtn.className = "sidebar-item text-gray-400";
            nextMessageBtn.title = "Следующее сообщение";
            nextMessageBtn.onclick = () => {
                if (window.chatAssistantAPI) {
                    window.chatAssistantAPI.navigateMessages('next');
                }
            };
            nextMessageBtn.innerHTML = `<i data-lucide="chevron-down" class="w-6 h-6"></i>`;
            leftSidebarCollapsedIcons.appendChild(nextMessageBtn);

            const newChatExpanded = document.createElement('a');
            newChatExpanded.href = "#";
            newChatExpanded.className = "sidebar-item-expanded text-gray-300";
            newChatExpanded.onclick = (e) => {
                e.preventDefault();
                // Простое создание нового чата через API
                fetch('/ai-assistant/api/conversations/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                }).then(response => response.json())
                  .then(newChat => {
                      console.log('New chat created:', newChat);
                      loadChats(); // Перезагрузить список
                      if (window.chatAssistantAPI) {
                          window.chatAssistantAPI.selectConversation(newChat.conversation_id);
                      }
                  }).catch(error => console.error('Error creating chat:', error));
            };
            newChatExpanded.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 flex-shrink-0"></i><span class="sidebar-text ml-4 font-medium">Новый чат</span>`;
            leftSidebarExpandedMenu.appendChild(newChatExpanded);

            // Разделитель только в развернутом виде
            leftSidebarExpandedMenu.innerHTML += '<hr class="border-t border-white/10 my-2">';

            // Список чатов (только в развернутом виде)
            const chatsContainerExpanded = document.createElement('div');
            chatsContainerExpanded.id = 'chats-container-expanded';
            chatsContainerExpanded.className = 'flex-1 overflow-y-auto space-y-1';
            chatsContainerExpanded.style.maxHeight = 'calc(100vh - 300px)'; // Ограничиваем высоту
            leftSidebarExpandedMenu.appendChild(chatsContainerExpanded);

            // Разделитель внизу только в развернутом виде
            leftSidebarExpandedMenu.innerHTML += '<hr class="border-t border-white/10 my-2">';

            // Кнопка "Поиск"
            const searchCollapsed = document.createElement('a');
            searchCollapsed.href = "#";
            searchCollapsed.className = "sidebar-item text-gray-300";
            searchCollapsed.title = "Поиск";
            searchCollapsed.innerHTML = `<i data-lucide="search" class="w-6 h-6"></i>`;
            leftSidebarCollapsedIcons.appendChild(searchCollapsed);

            const searchExpanded = document.createElement('a');
            searchExpanded.href = "#";
            searchExpanded.className = "sidebar-item-expanded text-gray-300";
            searchExpanded.innerHTML = `<i data-lucide="search" class="w-5 h-5 flex-shrink-0"></i><span class="sidebar-text ml-4 font-medium">Поиск</span>`;
            leftSidebarExpandedMenu.appendChild(searchExpanded);

            // Кнопка "Настройки"
            const settingsCollapsed = document.createElement('a');
            settingsCollapsed.href = "#";
            settingsCollapsed.className = "sidebar-item text-gray-300";
            settingsCollapsed.title = "Настройки";
            settingsCollapsed.innerHTML = `<i data-lucide="settings" class="w-6 h-6"></i>`;
            leftSidebarCollapsedIcons.appendChild(settingsCollapsed);

            const settingsExpanded = document.createElement('a');
            settingsExpanded.href = "#";
            settingsExpanded.className = "sidebar-item-expanded text-gray-300";
            settingsExpanded.innerHTML = `<i data-lucide="settings" class="w-5 h-5 flex-shrink-0"></i><span class="sidebar-text ml-4 font-medium">Настройки</span>`;
            leftSidebarExpandedMenu.appendChild(settingsExpanded);
        }

        // Функции для группировки чатов по датам
        function getDateGroup(dateString) {
            const chatDate = new Date(dateString);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // Начало текущей недели (понедельник)
            const currentWeekStart = new Date(today);
            const dayOfWeek = today.getDay();
            const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Воскресенье = 0
            currentWeekStart.setDate(today.getDate() - daysToMonday);
            
            // Начало прошлой недели
            const lastWeekStart = new Date(currentWeekStart);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            
            // Начало текущего месяца
            const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            if (chatDate >= today) {
                return 'today';
            } else if (chatDate >= yesterday) {
                return 'yesterday';
            } else if (chatDate >= currentWeekStart) {
                return 'thisWeek';
            } else if (chatDate >= lastWeekStart) {
                return 'lastWeek';
            } else if (chatDate >= currentMonthStart) {
                return 'thisMonth';
            } else {
                return 'older';
            }
        }
        
        function getGroupTitle(groupKey) {
            const titles = {
                'today': 'Сегодня',
                'yesterday': 'Вчера',
                'thisWeek': 'На этой неделе',
                'lastWeek': 'На прошлой неделе',
                'thisMonth': 'В этом месяце',
                'older': 'Раньше'
            };
            return titles[groupKey] || 'Другое';
        }
        
        function groupChatsByDate(chats) {
            const groups = {
                'today': [],
                'yesterday': [],
                'thisWeek': [],
                'lastWeek': [],
                'thisMonth': [],
                'older': []
            };
            
            chats.forEach(chat => {
                const group = getDateGroup(chat.created_at);
                groups[group].push(chat);
            });
            
            // Возвращаем только группы с чатами
            const result = [];
            Object.keys(groups).forEach(groupKey => {
                if (groups[groupKey].length > 0) {
                    result.push({
                        key: groupKey,
                        title: getGroupTitle(groupKey),
                        chats: groups[groupKey]
                    });
                }
            });
            
            return result;
        }
        
        function formatChatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date >= today) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } else if (date >= yesterday) {
                return 'Вчера';
            } else {
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
            }
        }

        // Простая загрузка чатов
        async function loadChats() {
            try {
                const response = await fetch('/ai-assistant/api/conversations/');
                if (response.ok) {
                    const conversations = await response.json();
                    console.log('Chats loaded:', conversations);
                    
                    // Сортируем по дате (новые сверху)
                    conversations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    renderChatsInSidebar(conversations);
                } else {
                    console.error('Failed to load chats:', response.status);
                }
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        // Простой рендеринг чатов в сайдбаре
        function renderChatsInSidebar(conversations) {
            const chatsContainer = document.getElementById('chats-container-expanded');
            if (!chatsContainer) return;

            chatsContainer.innerHTML = '';

            if (!conversations || conversations.length === 0) {
                chatsContainer.innerHTML = '<div class="text-gray-500 text-sm p-3 text-center">Нет чатов</div>';
                return;
            }

            conversations.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'relative group';
                
                const chatLink = document.createElement('a');
                chatLink.href = "#";
                chatLink.className = 'chat-item text-gray-300 pr-8 block cursor-pointer';
                chatLink.onclick = (e) => {
                    e.preventDefault();
                    if (window.chatAssistantAPI) {
                        window.chatAssistantAPI.selectConversation(chat.conversation_id);
                    }
                };
                
                // Простое отображение с title и датой
                const title = chat.title && chat.title !== 'New Conversation' 
                    ? chat.title 
                    : 'Новый чат';
                const displayTitle = title.length > 25 ? title.substring(0, 25) + '...' : title;
                const dateDisplay = formatChatDate(chat.created_at);
                
                chatLink.innerHTML = `
                    <div class="flex items-start">
                        <i data-lucide="message-circle" class="w-4 h-4 flex-shrink-0 text-gray-400 mt-1"></i>
                        <div class="ml-3 flex-1 min-w-0">
                            <div class="font-medium text-sm text-white truncate">${displayTitle}</div>
                            <div class="text-xs text-gray-500 truncate">${dateDisplay}</div>
                        </div>
                    </div>
                `;
                
                // Кнопка удаления
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'absolute right-2 top-1/2 transform -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity text-red-400 hover:text-red-300';
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm(`Удалить чат "${title}"?`)) {
                        try {
                            await fetch(`/ai-assistant/api/conversations/${chat.conversation_id}/`, {
                                method: 'DELETE'
                            });
                            loadChats(); // Перезагрузить список
                        } catch (error) {
                            console.error('Failed to delete chat:', error);
                        }
                    }
                };
                deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-3 h-3"></i>';
                
                chatItem.appendChild(chatLink);
                chatItem.appendChild(deleteBtn);
                chatsContainer.appendChild(chatItem);
            });

            // Обновить иконки
            lucide.createIcons();
        }
        // Рендеринг ПРАВОЙ боковой панели ("Дом")
        function renderRightSidebar() {
            rightSidebarCollapsedIcons.innerHTML = '';
            rightSidebarExpandedMenu.innerHTML = '';

            const homeCollapsed = document.createElement('a');
            homeCollapsed.href = "#";
            homeCollapsed.className = "sidebar-item text-gray-300";
            homeCollapsed.dataset.appCategory = 'home';
            homeCollapsed.title = "Главная";
            homeCollapsed.innerHTML = `<i data-lucide="layout-grid" class="w-6 h-6"></i>`;
            rightSidebarCollapsedIcons.appendChild(homeCollapsed);

            const homeExpanded = document.createElement('a');
            homeExpanded.href = "#";
            homeExpanded.className = "sidebar-item-expanded text-gray-300";
            homeExpanded.dataset.appCategory = 'home';
            homeExpanded.innerHTML = `<i data-lucide="layout-grid" class="w-5 h-5 flex-shrink-0"></i><span class="sidebar-text ml-4 font-medium">Главная</span>`;
            rightSidebarExpandedMenu.appendChild(homeExpanded);

            const archieCollapsed = document.createElement('a');
            archieCollapsed.href = "#";
            archieCollapsed.className = "sidebar-item text-gray-300 active"; // Archie активен по умолч.
            archieCollapsed.dataset.appCategory = 'archie';
            archieCollapsed.title = "Archie Чат";
            archieCollapsed.innerHTML = `<i data-lucide="brain" class="w-6 h-6"></i>`;
            rightSidebarCollapsedIcons.appendChild(archieCollapsed);

            const archieExpanded = document.createElement('a');
            archieExpanded.href = "#";
            archieExpanded.className = "sidebar-item-expanded text-gray-300 active";
            archieExpanded.dataset.appCategory = 'archie';
            archieExpanded.innerHTML = `<i data-lucide="brain" class="w-5 h-5 flex-shrink-0"></i><span class="sidebar-text ml-4 font-medium">Archie Чат</span>`;
            rightSidebarExpandedMenu.appendChild(archieExpanded);

            rightSidebarCollapsedIcons.innerHTML += '<hr class="border-t border-white/10 my-2">';
            rightSidebarExpandedMenu.innerHTML += '<hr class="border-t border-white/10 my-2">';

            dashboardData.smarthome_dashboard.tiles.forEach(tile => {
                const iconColorClass = getTailwindColorClass(tile.status_color);
                
                const collapsedItem = document.createElement('a');
                collapsedItem.href = `/${tile.category}/`;
                collapsedItem.className = `sidebar-item ${iconColorClass}`;
                collapsedItem.dataset.appCategory = tile.category;
                collapsedItem.title = tile.title;
                collapsedItem.innerHTML = `<i data-lucide="${tile.icon}" class="w-6 h-6"></i>`;
                rightSidebarCollapsedIcons.appendChild(collapsedItem);

                const expandedItem = document.createElement('a');
                expandedItem.href = `/${tile.category}/`;
                expandedItem.className = `sidebar-item-expanded text-gray-300`; // Текст всегда светлый
                expandedItem.dataset.appCategory = tile.category;
                expandedItem.innerHTML = `<i data-lucide="${tile.icon}" class="w-5 h-5 flex-shrink-0 ${iconColorClass}"></i><span class="sidebar-text ml-4 font-medium">${tile.title}</span>`;
                rightSidebarExpandedMenu.appendChild(expandedItem);
            });
        }

        // Рендеринг плиток Дашборда
        function renderDashboardGrid() {
            globalQuickActionsContainer.innerHTML = '';
            dashboardTilesContainer.innerHTML = '';
            
            // Определяем ориентацию экрана и разрешение
            const isLandscape = window.innerWidth > window.innerHeight;
            const isTabletLandscape = isLandscape && window.innerHeight <= 720;
            const isVeryLowScreen = isLandscape && window.innerHeight <= 600; // Для экстремально низких экранов
            
            // Устанавливаем CSS Grid классы в зависимости от ориентации
            let containerClasses = 'grid gap-6 mb-6';
            let tilesClasses = 'glass-tile rounded-2xl p-6 flex flex-col justify-between aspect-square cursor-pointer';
            let quickActionsClasses = 'flex flex-wrap gap-3';
            
            if (isLandscape) {
                // Альбомная ориентация: 3x2 (3 колонки, 2 ряда)
                containerClasses += ' grid-cols-3 grid-rows-2 max-w-5xl mx-auto';
                quickActionsClasses += ' max-w-5xl mx-auto';
            } else {
                // Портретная ориентация: 2x3 (2 колонки, 3 ряда)
                containerClasses += ' grid-cols-2 grid-rows-3 max-w-2xl mx-auto';
                quickActionsClasses += ' max-w-2xl mx-auto';
            }
            
            // Добавляем компактные стили для планшетов в альбомной ориентации
            if (isVeryLowScreen) {
                // Экстремально компактные стили для очень низких экранов (600px и меньше)
                containerClasses += ' dashboard-tiles-compact';
                tilesClasses += ' dashboard-tile-compact';
                quickActionsClasses += ' quick-actions-compact';
                
                // Применяем компактную высоту к контейнеру дашборда
                const dashboardContainer = dashboardTilesContainer.parentElement.parentElement;
                if (dashboardContainer) {
                    dashboardContainer.classList.add('dashboard-compact');
                }
            } else if (isTabletLandscape) {
                // Обычные компактные стили для планшетов (до 720px)
                containerClasses += ' dashboard-tiles-compact';
                tilesClasses += ' dashboard-tile-compact';
                quickActionsClasses += ' quick-actions-compact';
                
                // Применяем компактную высоту к контейнеру дашборда
                const dashboardContainer = dashboardTilesContainer.parentElement.parentElement;
                if (dashboardContainer) {
                    dashboardContainer.classList.add('dashboard-compact');
                }
            } else {
                // Убираем компактные классы если они были применены ранее
                const dashboardContainer = dashboardTilesContainer.parentElement.parentElement;
                if (dashboardContainer) {
                    dashboardContainer.classList.remove('dashboard-compact');
                }
            }
            
            dashboardTilesContainer.className = containerClasses;
            globalQuickActionsContainer.className = quickActionsClasses;
            
            if (dashboardData.smarthome_dashboard.quick_actions) {
                dashboardData.smarthome_dashboard.quick_actions.forEach(action => {
                    const button = document.createElement('button');
                    let buttonClasses = ['glass-button', 'px-6', 'py-3', 'rounded-lg', 'text-white', 'flex', 'items-center', 'gap-3', 'text-lg', 'font-medium']; // Large button стили
                    
                    // Добавляем компактный класс для планшетов
                    if (isVeryLowScreen) {
                        // Экстремально компактные кнопки для очень низких экранов
                        buttonClasses.push('quick-action-btn-compact');
                    } else if (isTabletLandscape) {
                        // Обычные компактные кнопки для планшетов
                        buttonClasses.push('quick-action-btn-compact');
                    }
                    
                    if (action.style === 'primary') buttonClasses.push('btn-primary');
                    else if (action.style === 'secondary') buttonClasses.push('btn-secondary');
                    button.className = buttonClasses.join(' ');
                    button.innerHTML = `<i data-lucide="${action.icon}" class="w-6 h-6"></i><span>${action.text}</span>`; // Крупные иконки
                    button.onclick = () => alert(`Запрос: "${action.assistant_request}"`);
                    globalQuickActionsContainer.appendChild(button);
                });
            }

            dashboardData.smarthome_dashboard.tiles.forEach(tile => {
                const tileElement = document.createElement('div');
                tileElement.className = tilesClasses;
                tileElement.onclick = () => window.location.href = `/${tile.category}/`;
                const statusIconColorClass = getTailwindColorClass(tile.status_color);

                let devicesHtml = '';
                if (tile.devices && tile.devices.length > 0) {
                    devicesHtml = `<div class="mt-4 flex flex-wrap gap-3">
                        ${tile.devices.map(device => {
                            const deviceIconColorClass = getTailwindColorClass(device.color);
                            const deviceBgColorClass = device.variant === 'solid' ? getTailwindBgColorClass(device.color) : '';
                            return `
                                <div class="relative device-wrapper">
                                    <div class="device-icon ${device.variant === 'solid' ? 'variant-solid ' + deviceBgColorClass : 'variant-outline'}">
                                        <i data-lucide="${device.icon}" class="w-5 h-5 ${deviceIconColorClass}"></i>
                                    </div>
                                    <span class="device-tooltip text-xs">${device.tooltip}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>`;
                }

                let quickActionsHtml = '';
                if (tile.quick_actions && tile.quick_actions.length > 0) {
                    quickActionsHtml = `<div class="mt-6 grid grid-cols-2 gap-2">
                        ${tile.quick_actions.map(action => `
                            <button class="glass-button text-xs px-3 py-1.5 rounded-lg text-white">${action}</button>
                        `).join('')}
                    </div>`;
                }

                tileElement.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start">
                            <h2 class="text-xl font-semibold text-white">${tile.title}</h2>
                            <i data-lucide="${tile.icon}" class="w-6 h-6 ${statusIconColorClass}"></i>
                        </div>
                        <p class="text-sm text-gray-300 mt-1">${tile.subtitle}</p>
                        ${devicesHtml}
                    </div>
                    ${quickActionsHtml}
                `;
                dashboardTilesContainer.appendChild(tileElement);
            });
        }

        // --- Функции управления состоянием ---

        // Показать "Чат"
        function showChatView() {
            chatView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            leftSidebar.classList.remove('hidden'); // Показываем левый сайдбар в режиме чата
            updateSidebarActiveState('archie');
        }

        // Показать "Дашборд"
        function showDashboardView() {
            chatView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            leftSidebar.classList.add('hidden'); // Скрываем левый сайдбар в режиме дашборда
            updateSidebarActiveState('home');
        }

        // Обновить активное состояние кнопок "Archie" / "Home"
        function updateSidebarActiveState(activeCategory) {
            document.querySelectorAll('#right-sidebar a').forEach(el => {
                if (el.dataset.appCategory === activeCategory) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
        }

        // Обновить состояние кнопок навигации по сообщениям
        function updateMessageNavigationButtons(currentIndex, totalMessages) {
            const prevBtn = document.getElementById('prev-message-btn');
            const nextBtn = document.getElementById('next-message-btn');
            
            if (!prevBtn || !nextBtn) return;

            // Кнопки видны только в свернутом состоянии левого сайдбара
            if (isLeftSidebarExpanded) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                return;
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
            }

            // Предыдущее сообщение доступно если индекс > 0
            if (currentIndex <= 0) {
                prevBtn.classList.add('opacity-30', 'cursor-not-allowed');
                prevBtn.classList.remove('text-gray-400');
                prevBtn.classList.add('text-gray-600');
                prevBtn.disabled = true;
            } else {
                prevBtn.classList.remove('opacity-30', 'cursor-not-allowed', 'text-gray-600');
                prevBtn.classList.add('text-gray-400');
                prevBtn.disabled = false;
            }

            // Следующее сообщение доступно если индекс < total - 1
            if (currentIndex >= totalMessages - 1) {
                nextBtn.classList.add('opacity-30', 'cursor-not-allowed');
                nextBtn.classList.remove('text-gray-400');
                nextBtn.classList.add('text-gray-600');
                nextBtn.disabled = true;
            } else {
                nextBtn.classList.remove('opacity-30', 'cursor-not-allowed', 'text-gray-600');
                nextBtn.classList.add('text-gray-400');
                nextBtn.disabled = false;
            }
        }

        // Свернуть/Развернуть ЛЕВУЮ панель
        function toggleLeftSidebar(forceCollapse = false) {
            isLeftSidebarExpanded = !isLeftSidebarExpanded;
            if (forceCollapse) isLeftSidebarExpanded = false;

            // Экспортируем состояние для React компонента
            window.isLeftSidebarExpanded = isLeftSidebarExpanded;

            if (isLeftSidebarExpanded) {
                leftSidebar.classList.remove('w-20');
                leftSidebar.classList.add('w-72');
                mainContentArea.style.marginLeft = '0'; // Убираем margin
                leftSidebarCollapsedIcons.classList.add('hidden');
                leftSidebarExpandedMenu.classList.remove('hidden');
                leftSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-left" class="w-6 h-6"></i>`;
                leftSidebarToggleBtn.title = "Свернуть панель";
                document.querySelectorAll('#left-sidebar .sidebar-text').forEach(el => el.style.opacity = '1');
                
                // Загружаем чаты при раскрытии панели
                loadChats();
            } else {
                leftSidebar.classList.add('w-20');
                leftSidebar.classList.remove('w-72');
                mainContentArea.style.marginLeft = '0'; // Убираем margin
                leftSidebarCollapsedIcons.classList.remove('hidden');
                leftSidebarExpandedMenu.classList.add('hidden');
                leftSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-right" class="w-6 h-6"></i>`;
                leftSidebarToggleBtn.title = "Развернуть панель";
                document.querySelectorAll('#left-sidebar .sidebar-text').forEach(el => el.style.opacity = '0');
            }
            lucide.createIcons({
                nodes: [leftSidebarToggleBtn]
            });
            
            // Обновляем состояние кнопок навигации по сообщениям при переключении
            if (window.chatAssistantAPI && window.chatAssistantAPI.updateNavigationButtons) {
                window.chatAssistantAPI.updateNavigationButtons();
            }
        }
        
        // Свернуть/Развернуть ПРАВУЮ панель
        function toggleRightSidebar(forceCollapse = false) {
            isRightSidebarExpanded = !isRightSidebarExpanded;
            if (forceCollapse) isRightSidebarExpanded = false;

            if (isRightSidebarExpanded) {
                rightSidebar.classList.remove('w-20');
                rightSidebar.classList.add('w-72');
                mainContentArea.style.marginRight = '0'; // Убираем margin
                rightSidebarCollapsedIcons.classList.add('hidden');
                rightSidebarExpandedMenu.classList.remove('hidden');
                rightSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-right" class="w-6 h-6"></i>`;
                rightSidebarToggleBtn.title = "Свернуть панель";
                document.querySelectorAll('#right-sidebar .sidebar-text').forEach(el => el.style.opacity = '1');
            } else {
                rightSidebar.classList.add('w-20');
                rightSidebar.classList.remove('w-72');
                mainContentArea.style.marginRight = '0'; // Убираем margin
                rightSidebarCollapsedIcons.classList.remove('hidden');
                rightSidebarExpandedMenu.classList.add('hidden');
                rightSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-left" class="w-6 h-6"></i>`;
                rightSidebarToggleBtn.title = "Развернуть панель";
                document.querySelectorAll('#right-sidebar .sidebar-text').forEach(el => el.style.opacity = '0');
            }
            lucide.createIcons({
                nodes: [rightSidebarToggleBtn]
            });
        }

        // --- Инициализация и обработчики событий ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Рендеринг всего
            renderLeftSidebar();
            renderRightSidebar();
            renderDashboardGrid();
            
            // 2. Инициализация иконок Lucide
            lucide.createIcons();

            // 3. Установка начального состояния
            showChatView(); // Показываем чат по умолчанию (левый сайдбар будет видим)
            // Устанавливаем иконки для кнопок сворачивания
            leftSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-right" class="w-6 h-6"></i>`;
            rightSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-left" class="w-6 h-6"></i>`;
            lucide.createIcons({ nodes: [leftSidebarToggleBtn, rightSidebarToggleBtn] });
            
            // Устанавливаем начальные отступы для контента
            mainContentArea.style.marginLeft = '0';
            mainContentArea.style.marginRight = '0';
            
            // Экспортируем начальное состояние для React компонента
            window.isLeftSidebarExpanded = isLeftSidebarExpanded;

            // 4. Обработчик клика на кнопку "Свернуть/Развернуть" (ЛЕВАЯ ПАНЕЛЬ)
            leftSidebarToggleBtn.addEventListener('click', () => toggleLeftSidebar());
            
            // 5. Обработчик клика на кнопку "Свернуть/Развернуть" (ПРАВАЯ ПАНЕЛЬ)
            rightSidebarToggleBtn.addEventListener('click', () => toggleRightSidebar());

            // 6. Обработчик кликов на элементы ПРАВОЙ ПАНЕЛИ (делегирование)
            rightSidebar.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (!link) return; 

                const category = link.dataset.appCategory;

                if (category === 'archie') {
                    e.preventDefault();
                    showChatView();
                } else if (category === 'home') {
                    e.preventDefault();
                    showDashboardView();
                    updateSidebarActiveState('home');
                } else {
                    // Для остальных категорий (light, weather и т.д.) позволяем переход по href
                    // Ссылки уже настроены на /${category}/
                }

                // Сворачиваем, если была развернута
                if (isRightSidebarExpanded) {
                    toggleRightSidebar(true); // force collapse
                }
            });
            
            // 7. Обработчики для сворачивания панелей (Escape и Клик)
            
            // Клик на центральный контент
            mainContentArea.addEventListener('click', () => {
                // Сворачиваем левый сайдбар только если он видим (режим чата)
                if (isLeftSidebarExpanded && !leftSidebar.classList.contains('hidden')) {
                    toggleLeftSidebar(true); // force collapse
                }
                if (isRightSidebarExpanded) {
                    toggleRightSidebar(true); // force collapse
                }
            });

            // Нажатие Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Сворачиваем левый сайдбар только если он видим (режим чата)
                    if (isLeftSidebarExpanded && !leftSidebar.classList.contains('hidden')) {
                        toggleLeftSidebar(true); // force collapse
                    }
                    if (isRightSidebarExpanded) {
                        toggleRightSidebar(true); // force collapse
                    }
                }
            });

            // Обработчик изменения размера окна для адаптивной сетки
            window.addEventListener('resize', () => {
                // Перерендериваем дашборд при изменении ориентации
                if (!dashboardView.classList.contains('hidden')) {
                    renderDashboardGrid();
                }
            });
        });

    </script>

    <!-- AI Assistant Integration -->
    <script type="module">
        // ChatAPI class - simplified version of the original
        class ChatAPI {
            constructor() {
                this.baseUrl = '/ai-assistant/api';
            }

            async getConversations() {
                try {
                    const response = await fetch(`${this.baseUrl}/conversations/`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('Failed to get conversations:', error);
                    return [];
                }
            }

            async createConversation() {
                try {
                    const response = await fetch(`${this.baseUrl}/conversations/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: `Новый чат ${Date.now()}` })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('Failed to create conversation:', error);
                    return null;
                }
            }

            async getMessages(conversationId) {
                try {
                    const response = await fetch(`${this.baseUrl}/conversations/${conversationId}/messages/`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('Failed to get messages:', error);
                    return [];
                }
            }

            async sendMessage(messageData) {
                try {
                    const response = await fetch(`${this.baseUrl}/messages/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(messageData)
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('Failed to send message:', error);
                    throw error;
                }
            }

            async deleteConversation(conversationId) {
                try {
                    const response = await fetch(`${this.baseUrl}/conversations/${conversationId}/`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    console.error('Failed to delete conversation:', error);
                    throw error;
                }
            }
        }

        // IntegratedChatAssistant - полноценный чат с AI-driven UI
        const IntegratedChatAssistant = () => {
            const { useState, useRef, useEffect } = React;
            
            // State
            const [conversations, setConversations] = useState([]);
            const [currentConversation, setCurrentConversation] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isLeftSidebarExpanded, setIsLeftSidebarExpanded] = useState(false);
            const [currentMessageIndex, setCurrentMessageIndex] = useState(-1); // Индекс текущего сообщения для навигации
            
            const messagesEndRef = useRef(null);
            const api = useRef(new ChatAPI());

            // Слушаем изменения состояния левого сайдбара
            useEffect(() => {
                const updateSidebarState = () => {
                    setIsLeftSidebarExpanded(window.isLeftSidebarExpanded || false);
                };
                
                // Проверяем каждые 100мс
                const interval = setInterval(updateSidebarState, 100);
                return () => clearInterval(interval);
            }, []);

            // Load conversations on mount
            useEffect(() => {
                loadConversations();
            }, []);

            // Scroll to bottom when messages change
            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Update navigation buttons when messages change or sidebar state changes
            useEffect(() => {
                const assistantMessages = messages.filter(msg => msg.role === 'assistant');
                const currentIndex = currentMessageIndex === -1 ? assistantMessages.length - 1 : currentMessageIndex;
                
                if (window.updateMessageNavigationButtons) {
                    window.updateMessageNavigationButtons(currentIndex, assistantMessages.length);
                }
                
                // Если индекс не установлен и есть сообщения, показываем последнее
                if (currentMessageIndex === -1 && assistantMessages.length > 0) {
                    setCurrentMessageIndex(assistantMessages.length - 1);
                }
            }, [messages, currentMessageIndex, isLeftSidebarExpanded]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const loadConversations = async () => {
                try {
                    const convos = await api.current.getConversations();
                    setConversations(convos);
                    
                    // Auto-select first conversation if exists
                    if (convos.length > 0 && !currentConversation) {
                        selectConversation(convos[0].conversation_id);
                    }
                } catch (err) {
                    setError(`Не удалось загрузить чаты: ${err.message}`);
                }
            };

            const selectConversation = async (conversationId) => {
                setCurrentConversation(conversationId);
                setCurrentMessageIndex(-1); // Сбрасываем индекс при смене разговора
                
                try {
                    const msgs = await api.current.getMessages(conversationId);
                    setMessages(msgs);
                } catch (err) {
                    setError(`Не удалось загрузить сообщения: ${err.message}`);
                }
            };

            const createNewChat = async () => {
                try {
                    const newConvo = await api.current.createConversation();
                    if (newConvo) {
                        setConversations(prev => [newConvo, ...prev]);
                        setCurrentConversation(newConvo.conversation_id);
                        setMessages([]);
                    }
                } catch (err) {
                    setError(`Не удалось создать новый чат: ${err.message}`);
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!inputValue.trim() || !currentConversation || isLoading) return;

                const userMessage = {
                    message_id: `temp-user-${Date.now()}`,
                    role: 'user',
                    content: {
                        content_format: 'plain',
                        text: inputValue
                    },
                    created_at: new Date().toISOString()
                };

                setMessages(prev => [...prev, userMessage]);
                setInputValue('');
                setIsLoading(true);

                try {
                    const result = await api.current.sendMessage({
                        response_format: 'ui_answer',
                        input: inputValue,
                        conversation_id: currentConversation
                    });

                    const assistantMessage = {
                        message_id: result.message_id || `temp-assistant-${Date.now()}`,
                        role: 'assistant',
                        content: result.content || {
                            content_format: 'ui_answer',
                            ui_answer: result.ui_answer
                        },
                        created_at: result.created_at || new Date().toISOString()
                    };

                    setMessages(prev => [...prev, assistantMessage]);
                } catch (err) {
                    setError(`Не удалось отправить сообщение: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const executeCommand = async (assistantRequest) => {
                if (!currentConversation) return;

                setIsLoading(true);

                try {
                    const result = await api.current.sendMessage({
                        response_format: 'ui_answer',
                        input: assistantRequest,
                        conversation_id: currentConversation
                    });

                    const assistantMessage = {
                        message_id: result.message_id || `temp-assistant-${Date.now()}`,
                        role: 'assistant',
                        content: result.content || {
                            content_format: 'ui_answer',
                            ui_answer: result.ui_answer
                        },
                        created_at: result.created_at || new Date().toISOString()
                    };

                    setMessages(prev => [...prev, assistantMessage]);
                } catch (err) {
                    setError(`Ошибка выполнения команды: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const navigateMessages = (direction) => {
                const assistantMessages = messages.filter(msg => msg.role === 'assistant');
                if (assistantMessages.length === 0) return;

                let newIndex = currentMessageIndex;
                
                if (direction === 'prev') {
                    newIndex = Math.max(0, currentMessageIndex - 1);
                } else if (direction === 'next') {
                    newIndex = Math.min(assistantMessages.length - 1, currentMessageIndex + 1);
                }

                if (newIndex !== currentMessageIndex) {
                    setCurrentMessageIndex(newIndex);
                }
            };

            const updateNavigationButtons = () => {
                const assistantMessages = messages.filter(msg => msg.role === 'assistant');
                const currentIndex = currentMessageIndex === -1 ? assistantMessages.length - 1 : currentMessageIndex;
                
                if (window.updateMessageNavigationButtons) {
                    window.updateMessageNavigationButtons(currentIndex, assistantMessages.length);
                }
            };

            const formatTime = (dateString) => {
                return new Date(dateString).toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            };

            // AI-driven UI rendering functions
            const getSpacingClass = (spacing) => {
                switch (spacing) {
                    case 'tight': return 'space-y-2';
                    case 'loose': return 'space-y-8';
                    default: return 'space-y-4';
                }
            };

            const getButtonStyle = (style) => {
                switch (style) {
                    case 'primary': return 'bg-indigo-600 hover:bg-indigo-500 text-white';
                    case 'success': return 'bg-green-600 hover:bg-green-500 text-white';
                    case 'warning': return 'bg-yellow-500 hover:bg-yellow-400 text-slate-900';
                    case 'danger': return 'bg-red-600 hover:bg-red-500 text-white';
                    default: return 'bg-slate-700 hover:bg-slate-600 text-white';
                }
            };

            const renderAdvancedAnswerItem = (item) => {
                switch (item.type) {
                    case 'text_answer':
                        return React.createElement('div', {
                            key: `text-${item.order}`,
                            className: 'prose prose-invert max-w-none',
                            dangerouslySetInnerHTML: { __html: item.content.text }
                        });
                    
                    case 'card_grid':
                        return renderCardGrid(item.content, item.order);
                    
                    case 'table':
                        return renderTable(item.content, item.order);
                    
                    case 'chart':
                        return renderChart(item.content, item.order);
                    
                    default:
                        return React.createElement('div', {
                            key: `unknown-${item.order}`,
                            className: 'text-white/70'
                        }, `Неподдерживаемый тип элемента: ${item.type}`);
                }
            };

            const renderCardGrid = (cardGrid, order) => {
                const gridClass = cardGrid.grid_dimensions === '2_columns' 
                    ? 'grid grid-cols-1 md:grid-cols-2 gap-4' 
                    : 'grid grid-cols-1 gap-4';

                return React.createElement('div', {
                    key: `card-grid-${order}`,
                    className: gridClass
                }, cardGrid.cards.map((card, index) => 
                    React.createElement('div', {
                        key: `card-${index}`,
                        className: 'backdrop-blur-lg bg-white/10 rounded-2xl p-4 border border-white/20 shadow-xl hover:shadow-slate-500/30 transition-all duration-300 hover:scale-105'
                    }, [
                        card.title && React.createElement('h3', {
                            key: 'title',
                            className: 'font-semibold text-white mb-2'
                        }, card.title),
                        card.subtitle && React.createElement('p', {
                            key: 'subtitle',
                            className: 'text-sm text-white/70 mb-2'
                        }, card.subtitle),
                        card.text && React.createElement('div', {
                            key: 'text',
                            className: 'text-white/80 text-sm mb-3',
                            dangerouslySetInnerHTML: { __html: card.text }
                        }),
                        card.buttons && card.buttons.length > 0 && React.createElement('div', {
                            key: 'buttons',
                            className: 'flex flex-wrap gap-2 mt-3'
                        }, card.buttons.map((button, buttonIndex) => renderButton(button, buttonIndex)))
                    ])
                ));
            };

            const renderButton = (button, index) => {
                const handleClick = () => {
                    if (button.type === 'assistant_button') {
                        executeCommand(button.assistant_request);
                    } else {
                        // Handle frontend commands
                        console.log('Frontend command:', button.command);
                    }
                };

                return React.createElement('button', {
                    key: `button-${index}`,
                    onClick: handleClick,
                    className: `px-3 py-2 rounded-full text-sm font-semibold transition-all duration-300 hover:scale-105 active:scale-95 ${getButtonStyle(button.style)}`
                }, [
                    button.icon && React.createElement('span', {
                        key: 'icon',
                        className: 'mr-2'
                    }, button.icon),
                    React.createElement('span', {
                        key: 'text'
                    }, button.text)
                ]);
            };

            const renderTable = (table, order) => {
                return React.createElement('div', {
                    key: `table-${order}`,
                    className: 'backdrop-blur-lg bg-white/10 rounded-lg border border-white/20 shadow-xl overflow-hidden'
                }, [
                    table.title && React.createElement('div', {
                        key: 'table-header',
                        className: 'p-4 bg-slate-800/80 border-b border-slate-700/50'
                    }, React.createElement('h3', {
                        className: 'font-semibold text-white'
                    }, table.title)),
                    React.createElement('div', {
                        key: 'table-wrapper',
                        className: 'overflow-x-auto'
                    }, React.createElement('table', {
                        className: 'w-full'
                    }, [
                        React.createElement('thead', {
                            key: 'thead',
                            className: 'bg-slate-800/50'
                        }, React.createElement('tr', {}, 
                            table.headers.map((header, index) => 
                                React.createElement('th', {
                                    key: `header-${index}`,
                                    className: 'px-4 py-3 text-left text-white font-semibold'
                                }, header)
                            )
                        )),
                        React.createElement('tbody', {
                            key: 'tbody'
                        }, table.rows.map((row, rowIndex) =>
                            React.createElement('tr', {
                                key: `row-${rowIndex}`,
                                className: 'border-t border-white/10 hover:bg-white/5'
                            }, row.map((cell, cellIndex) =>
                                React.createElement('td', {
                                    key: `cell-${cellIndex}`,
                                    className: 'px-4 py-3 text-white/80'
                                }, cell)
                            ))
                        ))
                    ]))
                ]);
            };

            const renderChart = (chart, order) => {
                return React.createElement('div', {
                    key: `chart-${order}`,
                    className: 'backdrop-blur-lg bg-white/10 rounded-xl shadow-2xl p-6 border border-white/20'
                }, [
                    chart.title && React.createElement('h3', {
                        key: 'chart-title',
                        className: 'text-xl font-bold text-white mb-2'
                    }, chart.title),
                    chart.description && React.createElement('p', {
                        key: 'chart-description',
                        className: 'text-white/70 mb-4'
                    }, chart.description),
                    React.createElement('div', {
                        key: 'chart-container',
                        style: { height: `${chart.height || 300}px` }
                    }, React.createElement('div', {
                        className: 'text-white/50 flex items-center justify-center h-full'
                    }, `График (Chart.js) - ${chart.chart_type}`))
                ]);
            };

            const renderUIAnswer = (uiAnswer) => {
                return React.createElement('div', {
                    className: 'space-y-6'
                }, [
                    // Intro text
                    uiAnswer.intro_text && React.createElement('div', {
                        key: 'intro',
                        className: 'prose prose-invert max-w-none',
                        dangerouslySetInnerHTML: { __html: uiAnswer.intro_text.text }
                    }),

                    // Items
                    React.createElement('div', {
                        key: 'items'
                    }, uiAnswer.items.sort((a, b) => a.order - b.order).map((item, index) => 
                        React.createElement('div', {
                            key: `item-${index}`,
                            className: getSpacingClass(item.spacing)
                        }, renderAdvancedAnswerItem(item))
                    )),

                    // Quick action buttons
                    uiAnswer.quick_action_buttons && React.createElement('div', {
                        key: 'quick-actions',
                        className: 'flex flex-wrap gap-3 pt-4 border-t border-white/20'
                    }, uiAnswer.quick_action_buttons.buttons.map((button, index) =>
                        React.createElement('button', {
                            key: `quick-${index}`,
                            onClick: () => executeCommand(button.assistant_request),
                            className: `px-4 py-2 rounded-full font-semibold transition-all duration-300 hover:scale-105 active:scale-95 ${getButtonStyle(button.style)}`
                        }, [
                            button.icon && React.createElement('span', {
                                key: 'icon',
                                className: 'mr-2'
                            }, button.icon),
                            React.createElement('span', {
                                key: 'text'
                            }, button.text)
                        ])
                    ))
                ]);
            };

            const renderContent = (content) => {
                if (content.text) {
                    // Simple text content
                    return React.createElement('div', {
                        className: 'prose prose-invert max-w-none',
                        dangerouslySetInnerHTML: { __html: content.text }
                    });
                }

                if (content.ui_answer) {
                    return renderUIAnswer(content.ui_answer);
                }

                return React.createElement('div', {
                    className: 'text-white/70'
                }, 'Неподдерживаемый формат контента');
            };

            const renderMessage = (message) => {
                const isUser = message.role === 'user';
                
                return React.createElement('div', {
                    key: message.message_id,
                    className: `mb-6 flex ${isUser ? 'justify-end' : 'justify-start'}`
                }, [
                    React.createElement('div', {
                        key: 'message-container',
                        className: `max-w-[85%] ${isUser ? 'order-2' : 'order-1'}`
                    }, [
                        React.createElement('div', {
                            key: 'message-bubble',
                            className: `backdrop-blur-lg rounded-3xl p-6 border shadow-2xl relative group ${
                                isUser 
                                    ? 'bg-gradient-to-r from-slate-600 to-slate-700 border-slate-500/30 text-white' 
                                    : 'bg-white/10 border-white/20 text-white'
                            }`
                        }, [
                            React.createElement('div', {
                                key: 'message-header',
                                className: 'flex items-center gap-2 mb-3'
                            }, [
                                React.createElement('div', {
                                    key: 'avatar',
                                    className: `w-8 h-8 rounded-full flex items-center justify-center ${
                                        isUser ? 'bg-slate-500' : 'bg-blue-500'
                                    }`
                                }, [
                                    React.createElement('i', {
                                        key: 'avatar-icon',
                                        'data-lucide': isUser ? 'user' : 'bot',
                                        className: 'w-4 h-4'
                                    })
                                ]),
                                React.createElement('span', {
                                    key: 'role',
                                    className: 'font-semibold'
                                }, isUser ? 'Вы' : 'Archie'),
                                React.createElement('span', {
                                    key: 'time',
                                    className: 'text-xs opacity-70'
                                }, formatTime(message.created_at))
                            ]),
                            React.createElement('div', {
                                key: 'message-content',
                                className: 'message-content'
                            }, renderContent(message.content))
                        ])
                    ])
                ]);
            };

            // Expose functions globally for left sidebar integration
            useEffect(() => {
                window.chatAssistantAPI = {
                    createNewChat,
                    conversations,
                    currentConversation,
                    selectConversation,
                    navigateMessages,
                    updateNavigationButtons
                };
            }, [conversations, currentConversation, navigateMessages, updateNavigationButtons]);

            if (!currentConversation) {
                return React.createElement('div', {
                    className: 'h-full flex flex-col items-center justify-center text-center'
                }, [
                    React.createElement('div', {
                        key: 'empty-state',
                        className: 'text-white/60'
                    }, [
                        React.createElement('i', {
                            key: 'icon',
                            'data-lucide': 'message-circle',
                            className: 'w-16 h-16 mx-auto mb-4'
                        }),
                        React.createElement('h3', {
                            key: 'title',
                            className: 'text-xl font-semibold mb-2'
                        }, 'Выберите чат'),
                        React.createElement('p', {
                            key: 'description',
                            className: 'text-sm'
                        }, 'Создайте новый чат или выберите существующий из левой панели'),
                        React.createElement('button', {
                            key: 'create-button',
                            onClick: createNewChat,
                            className: 'mt-4 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-full transition-colors'
                        }, 'Создать новый чат')
                    ])
                ]);
            }

            // Определяем, что показывать: диалог или конкретное сообщение по индексу
            const messagesToShow = (() => {
                if (isLeftSidebarExpanded) {
                    return messages; // Показываем все сообщения в развернутом режиме
                } else {
                    // В свернутом режиме показываем только сообщения ассистента
                    const assistantMessages = messages.filter(msg => msg.role === 'assistant');
                    if (assistantMessages.length === 0) return [];
                    
                    // Показываем сообщение по currentMessageIndex или последнее
                    const index = currentMessageIndex >= 0 && currentMessageIndex < assistantMessages.length 
                        ? currentMessageIndex 
                        : assistantMessages.length - 1;
                    
                    return [assistantMessages[index]];
                }
            })();

            return React.createElement('div', {
                className: 'h-full flex flex-col bg-transparent'
            }, [
                // Messages area
                React.createElement('div', {
                    key: 'messages-area',
                    className: `flex-1 overflow-y-auto px-4 ${!isLeftSidebarExpanded ? 'py-4' : 'py-4'}`
                }, [
                    // В свернутом режиме оборачиваем в контейнер который центрирует только если контент меньше экрана
                    !isLeftSidebarExpanded && messagesToShow.length === 1 
                        ? React.createElement('div', {
                            key: 'single-message-container',
                            className: 'min-h-full flex flex-col justify-center'
                        }, [
                            React.createElement('div', {
                                key: 'centered-message',
                                className: 'w-full max-w-4xl mx-auto'
                            }, messagesToShow.map(renderMessage))
                        ])
                        : messagesToShow.map(renderMessage),
                    isLoading && React.createElement('div', {
                        key: 'loading',
                        className: `flex ${!isLeftSidebarExpanded ? 'justify-center' : 'justify-start'} mb-6`
                    }, [
                        React.createElement('div', {
                            key: 'loading-bubble',
                            className: 'backdrop-blur-lg rounded-3xl p-6 bg-white/10 border border-white/20'
                        }, [
                            React.createElement('div', {
                                key: 'loading-text',
                                className: 'text-white/60 mb-2'
                            }, 'Archie печатает'),
                            React.createElement('div', {
                                key: 'loading-dots',
                                className: 'flex gap-1'
                            }, [
                                React.createElement('div', {
                                    key: 'dot1',
                                    className: 'w-2 h-2 bg-white/60 rounded-full animate-pulse'
                                }),
                                React.createElement('div', {
                                    key: 'dot2',
                                    className: 'w-2 h-2 bg-white/60 rounded-full animate-pulse',
                                    style: { animationDelay: '0.2s' }
                                }),
                                React.createElement('div', {
                                    key: 'dot3',
                                    className: 'w-2 h-2 bg-white/60 rounded-full animate-pulse',
                                    style: { animationDelay: '0.4s' }
                                })
                            ])
                        ])
                    ]),
                    React.createElement('div', {
                        key: 'messages-end',
                        ref: messagesEndRef
                    })
                ]),
                
                // Input area
                React.createElement('div', {
                    key: 'input-area',
                    className: 'p-4'
                }, [
                    React.createElement('div', {
                        key: 'input-container',
                        className: 'relative'
                    }, [
                        React.createElement('div', {
                            key: 'input-bg',
                            className: 'absolute inset-0 bg-white/10 backdrop-blur-md border border-white/20 rounded-xl'
                        }),
                        React.createElement('form', {
                            key: 'input-form',
                            className: 'relative flex items-center p-2',
                            onSubmit: sendMessage
                        }, [
                            React.createElement('input', {
                                key: 'input-field',
                                type: 'text',
                                placeholder: 'Напишите что-нибудь...',
                                className: 'flex-1 bg-transparent text-white placeholder-gray-400 border-none outline-none focus:ring-0 p-3',
                                value: inputValue,
                                onChange: (e) => setInputValue(e.target.value),
                                disabled: isLoading || !currentConversation
                            }),
                            React.createElement('button', {
                                key: 'send-button',
                                type: 'submit',
                                disabled: !inputValue.trim() || isLoading || !currentConversation,
                                className: 'p-3 text-gray-400 hover:text-white transition-colors rounded-lg disabled:opacity-50'
                            }, React.createElement('i', {
                                'data-lucide': 'send',
                                className: 'w-6 h-6'
                            }))
                        ])
                    ])
                ]),

                // Error display
                error && React.createElement('div', {
                    key: 'error',
                    className: 'fixed bottom-4 right-4 bg-red-600 text-white px-6 py-3 rounded-full shadow-lg'
                }, [
                    React.createElement('span', { key: 'error-text' }, error),
                    React.createElement('button', {
                        key: 'error-close',
                        onClick: () => setError(null),
                        className: 'ml-3 text-white/80 hover:text-white'
                    }, React.createElement('i', {
                        'data-lucide': 'x',
                        className: 'w-4 h-4'
                    }))
                ])
            ]);
        };
        
        // Initialize AI Assistant
        function initializeChatAssistant() {
            const chatContainer = document.getElementById('chat-assistant-root');
            if (!chatContainer) {
                console.error('Chat assistant container not found');
                return;
            }

            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                console.error('React or ReactDOM not loaded');
                return;
            }

            try {
                const root = ReactDOM.createRoot(chatContainer);
                root.render(React.createElement(IntegratedChatAssistant));
                
                // Re-initialize Lucide icons
                setTimeout(() => {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 100);
                
                console.log('Integrated AI Assistant initialized successfully');
            } catch (error) {
                console.error('Failed to initialize AI Assistant:', error);
                chatContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-white/60">
                            <p class="text-lg">AI Assistant загружается...</p>
                            <p class="text-sm mt-2">Если проблема не исчезает, обновите страницу</p>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeChatAssistant, 100);
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archie AI Home</title>
    
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Подключение библиотеки иконок Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Подключение шрифта Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body, html {
            font-family: 'Inter', sans-serif;
            height: 100%;
            overflow: hidden; /* Предотвращаем прокрутку body */
            background: #000;
        }
        
        /* Стили для кастомной полосы прокрутки */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 3px;
        }
        
        /* Анимация пульсации для шара */
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 25px 4px rgba(0, 191, 255, 0.4);
                transform: translate(-50%, -50%) scale(0.98);
            }
            50% {
                box-shadow: 0 0 50px 15px rgba(0, 191, 255, 0.7);
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .orb {
            width: 300px;
            height: 300px;
            background: #050505;
            border-radius: 50%;
            animation: pulse 4s infinite ease-in-out;
            box-shadow: 0 0 25px 4px rgba(0, 191, 255, 0.4);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Стили для "Матового стекла" */
        .frosted-glass-card {
            background-color: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 191, 255, 0.25);
            border-radius: 0.75rem;
            padding: 1.25rem;
        }
        
        .glass-tile {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease;
        }
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Стили для всплывающих подсказок */
        .device-wrapper {
            position: relative;
            display: inline-block;
        }
        .device-tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            position: absolute;
            z-index: 50;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .device-wrapper:hover .device-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Стили для боковых панелей (сайдбаров) */
        .sidebar {
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0.75rem; /* 12px */
            transition: all 0.3s ease-in-out;
            z-index: 40;
        }
        
        /* Стили для кнопок в сайдбарах */
        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 56px; /* 14 * 4 */
            width: 56px; /* 14 * 4 */
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .sidebar-item.active {
            background: rgba(0, 191, 255, 0.2);
            color: #00bfff; /* DeepSkyBlue */
        }
        
        /* Стили для развернутых кнопок */
        .sidebar-item-expanded {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 1rem; /* 16px */
            height: 48px; /* 12 * 4 */
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .sidebar-item-expanded:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .sidebar-item-expanded.active {
            background: rgba(0, 191, 255, 0.2);
            color: #00bfff;
        }
        .sidebar-text {
            opacity: 0;
            transition: opacity 0.2s ease 0.1s;
        }
        
        /* Контейнер для основного контента */
        #main-content-area {
            position: relative;
            flex: 1;
            height: 100%;
            overflow: hidden; /* Важно: скрываем overflow здесь */
            z-index: 10;
            transition: all 0.3s ease-in-out;
        }

        /* Оба "экрана" (Чат и Дашборд) */
        .view-screen {
            position: absolute;
            inset: 0;
            overflow-y: auto; /* Прокрутка *внутри* каждого экрана */
            padding: 1rem; /* Отступы для прокрутки */
        }

    </style>
</head>
<body class="bg-black text-gray-300 h-screen overflow-hidden flex">

    <!-- 
      ЛЕВАЯ БОКОВАЯ ПАНЕЛЬ ("Арчи")
    -->
    <nav id="left-sidebar" class="sidebar" style="border-right: 1px solid rgba(255, 255, 255, 0.1);">
        <!-- Верхняя группа: Приложения "Арчи" -->
        <div>
            <!-- Контейнер для свернутых иконок -->
            <div id="left-sidebar-collapsed-icons" class="space-y-3">
                <a href="#" class="sidebar-item text-gray-300" title="Новый чат">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i>
                </a>
                <a href="#" class="sidebar-item text-gray-300" title="Поиск">
                    <i data-lucide="search" class="w-6 h-6"></i>
                </a>
                <a href="#" class="sidebar-item text-gray-300" title="Настройки">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </a>
            </div>
            
            <!-- Контейнер для развернутого меню -->
            <div id="left-sidebar-expanded-menu" class="hidden space-y-2">
                 <a href="#" class="sidebar-item-expanded text-gray-300">
                    <i data-lucide="plus-circle" class="w-5 h-5 flex-shrink-0"></i>
                    <span class="sidebar-text ml-4 font-medium">Новый чат</span>
                </a>
                 <a href="#" class="sidebar-item-expanded text-gray-300">
                    <i data-lucide="search" class="w-5 h-5 flex-shrink-0"></i>
                    <span class="sidebar-text ml-4 font-medium">Поиск</span>
                </a>
                 <a href="#" class="sidebar-item-expanded text-gray-300">
                    <i data-lucide="settings" class="w-5 h-5 flex-shrink-0"></i>
                    <span class="sidebar-text ml-4 font-medium">Настройки</span>
                </a>
            </div>
        </div>

        <!-- Нижняя группа: Свернуть/Развернуть -->
        <div class="space-y-3">
            <button id="left-sidebar-toggle-btn" class="sidebar-item text-gray-400 w-14 h-14" title="Развернуть панель">
                <!-- Иконка будет меняться JS -->
            </button>
        </div>
    </nav>

    <!-- 
      ОСНОВНАЯ ОБЛАСТЬ КОНТЕНТА
      (Содержит фон и переключаемые экраны)
    -->
    <main id="main-content-area">

        <!-- Слой 1: Анимированный Фон -->
        <div class="orb z-0"></div>

        <!-- 
          ЭКРАН 1: ЧАТ АРЧИ (z-10)
        -->
        <div id="chat-view" class="view-screen z-10">
            <div class="flex flex-col h-full w-full max-w-3xl mx-auto">
                <!-- Область сообщений (прокручиваемая) -->
                <div class="flex-1 space-y-4 pt-10">
                    <!-- Примеры карточек Арчи -->
                    <div class="frosted-glass-card">
                        <h3 class="text-lg font-semibold text-white mb-2">Задачи на сегодня</h3>
                        <ul class="divide-y divide-cyan-400/10">
                            <li class="flex justify-between items-center py-2">
                                <span class="text-gray-300">Подготовка отчёта</span>
                                <span class="text-yellow-400 text-sm">В процессе</span>
                            </li>
                            <li class="flex justify-between items-center py-2">
                                <span class="text-gray-300">Переговоры с клиентом</span>
                                <span class="text-green-400 text-sm">Готово</span>
                            </li>
                        </ul>
                    </div>
                     <div class="frosted-glass-card">
                        <h3 class="text-lg font-semibold text-white mb-2">Быстрый доступ</h3>
                        <p class="text-gray-400">Пример контента для чата...</p>
                    </div>
                </div>

                <!-- Поле для ввода текста (приклеено к низу) -->
                <div class="p-4 w-full pb-6 sticky bottom-0">
                    <div class="relative">
                        <div class="absolute inset-0 bg-white/10 backdrop-blur-md border border-white/20 rounded-xl"></div>
                        <form class="relative flex items-center p-2">
                            <input type="text"
                                   placeholder="Напишите что-нибудь..."
                                   class="flex-1 bg-transparent text-white placeholder-gray-400 border-none outline-none focus:ring-0 p-3">
                            <button type="submit" class="p-3 text-gray-400 hover:text-white transition-colors rounded-lg">
                                <i data-lucide="send" class="w-6 h-6"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 
          ЭКРАН 2: ДАШБОРД УМНОГО ДОМА (z-10, скрыт)
        -->
        <div id="dashboard-view" class="view-screen z-10 hidden">
             <header class="mb-8">
                <h1 class="text-3xl font-bold text-white/90">Панель Управления</h1>
                <p class="text-lg text-gray-400">Обзор вашего умного дома</p>
                <div id="global-quick-actions" class="mt-4 flex flex-wrap gap-3">
                    <!-- Кнопки будут генерироваться здесь JS -->
                </div>
            </header>

            <div id="dashboard-tiles" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Плитки будут генерироваться здесь JS -->
            </div>
        </div>

    </main>
    
    <!-- 
      ПРАВАЯ БОКОВАЯ ПАНЕЛЬ ("Дом")
    -->
    <nav id="right-sidebar" class="sidebar" style="border-left: 1px solid rgba(255, 255, 255, 0.1);">
        <!-- Верхняя группа: Приложения "Дома" -->
        <div>
            <!-- Контейнер для свернутых иконок -->
            <div id="right-sidebar-collapsed-icons" class="space-y-3">
                <!-- Сюда JS добавит иконки "Главная", "Archie" и приложения -->
            </div>
            
            <!-- Контейнер для развернутого меню -->
            <div id="right-sidebar-expanded-menu" class="hidden space-y-2">
                <!-- Сюда JS добавит пункты меню "Главная", "Archie" и приложения -->
            </div>
        </div>

        <!-- Нижняя группа: Свернуть/Развернуть -->
        <div class="space-y-3">
            <button id="right-sidebar-toggle-btn" class="sidebar-item text-gray-400 w-14 h-14" title="Развернуть панель">
                <!-- Иконка будет меняться JS -->
            </button>
        </div>
    </nav>


    <script>
        // Данные из JSON для дашборда
        const dashboardData = {
            "type": "tool_call",
            "voice_response": "Создаю атмосферу джазового бара: приглушаю свет и запускаю джазовую музыку.",
            "smarthome_dashboard": {
                "type": "smarthome_dashboard",
                "tiles": [
                    { "category": "light", "title": "Свет", "subtitle": "2 из 3 включены, тёплый белый", "icon": "lightbulb", "status_color": "orange", "quick_actions": ["Выключить все", "Приглушить свет", "Сменить цвет"], "devices": [{ "name": "Торшер комната 1", "icon": "lamp", "color": "orange", "variant": "outline", "tooltip": "Выкл., 80%, 3000K" }, { "name": "Потолочная комната 1", "icon": "lightbulb", "color": "orange", "variant": "solid", "tooltip": "Вкл., 60%, 4000K" }, { "name": "Спальня", "icon": "bed", "color": "yellow", "variant": "solid", "tooltip": "Вкл., 40%, 2700K" }] },
                    { "category": "music", "title": "Музыка", "subtitle": "Не играет", "icon": "music", "status_color": "gray", "quick_actions": ["Джаз плейлист", "Расслабляющая музыка", "Последний трек"], "devices": null },
                    { "category": "documents", "title": "Документы", "subtitle": "Поиск готов", "icon": "file-search", "status_color": "blue", "quick_actions": ["Найти документ", "Последние файлы", "Архив"], "devices": null },
                    { "category": "camera", "title": "Камера", "subtitle": "Недоступно", "icon": "camera", "status_color": "gray", "quick_actions": ["Настройки"], "devices": null },
                    { "category": "climate", "title": "Климат", "subtitle": "Средняя 21.8°C, обогрев активен", "icon": "thermometer", "status_color": "orange", "quick_actions": ["Эко режим", "Снизить температуру", "Выключить обогрев"], "devices": [{ "name": "Регулятор комната 1", "icon": "flame", "color": "orange", "variant": "solid", "tooltip": "22.5°C→23.0°C, 45%, обогрев" }, { "name": "Регулятор комната 2", "icon": "thermometer", "color": "green", "variant": "outline", "tooltip": "21.0°C→21.5°C, 48%, выкл." }] },
                    { "category": "security", "title": "Безопасность", "subtitle": "Система отключена", "icon": "shield", "status_color": "gray", "quick_actions": ["Настройки"], "devices": null },
                    { "category": "settings", "title": "Настройки", "subtitle": "Конфигурация", "icon": "settings", "status_color": "gray", "quick_actions": ["Открыть настройки"], "devices": null }
                ],
                "quick_actions": [
                    { "type": "assistant_button", "text": "Джазовая атмосфера", "style": "primary", "icon": "music", "assistant_request": "Создать атмосферу джазового бара" },
                    { "type": "assistant_button", "text": "Выключить свет", "style": "secondary", "icon": "lightbulb-off", "assistant_request": "Выключить весь свет" }
                ]
            }
        };

        // --- Глобальные переменные состояния ---
        let isLeftSidebarExpanded = false;
        let isRightSidebarExpanded = false;

        // --- Получение ссылок на DOM-элементы ---
        
        // --- Левая панель ---
        const leftSidebar = document.getElementById('left-sidebar');
        const leftSidebarCollapsedIcons = document.getElementById('left-sidebar-collapsed-icons');
        const leftSidebarExpandedMenu = document.getElementById('left-sidebar-expanded-menu');
        const leftSidebarToggleBtn = document.getElementById('left-sidebar-toggle-btn');
        
        // --- Правая панель ---
        const rightSidebar = document.getElementById('right-sidebar');
        const rightSidebarCollapsedIcons = document.getElementById('right-sidebar-collapsed-icons');
        const rightSidebarExpandedMenu = document.getElementById('right-sidebar-expanded-menu');
        const rightSidebarToggleBtn = document.getElementById('right-sidebar-toggle-btn');
        
        // --- Контент ---
        const mainContentArea = document.getElementById('main-content-area');
        const chatView = document.getElementById('chat-view');
        const dashboardView = document.getElementById('dashboard-view');
        
        // --- Элементы Дашборда ---
        const globalQuickActionsContainer = document.getElementById('global-quick-actions');
        const dashboardTilesContainer = document.getElementById('dashboard-tiles');

        // --- Вспомогательные функции ---

        // (getTailwindColorClass и getTailwindBgColorClass)
        function getTailwindColorClass(colorName, shade = 400) {
            const colorMap = { "gray": "gray", "green": "green", "blue": "blue", "orange": "orange", "yellow": "yellow", "red": "red", "purple": "purple" };
            return `text-${colorMap[colorName] || 'gray'}-${shade}`;
        }
        function getTailwindBgColorClass(colorName, shade = 600, opacity = 20) {
            const colorMap = { "gray": "gray", "green": "green", "blue": "blue", "orange": "orange", "yellow": "yellow", "red": "red", "purple": "purple" };
            return `bg-${colorMap[colorName] || 'gray'}-${shade}/${opacity}`;
        }

        // --- Функции рендеринга ---

        // Рендеринг ПРАВОЙ боковой панели ("Дом")
        function renderRightSidebar() {
            rightSidebarCollapsedIcons.innerHTML = '';
            rightSidebarExpandedMenu.innerHTML = '';

            const homeCollapsed = document.createElement('a');
            homeCollapsed.href = "#";
            homeCollapsed.className = "sidebar-item text-gray-300";
            homeCollapsed.dataset.appCategory = 'home';
            homeCollapsed.title = "Главная";
            homeCollapsed.innerHTML = `<i data-lucide="layout-grid" class="w-6 h-6"></i>`;
            rightSidebarCollapsedIcons.appendChild(homeCollapsed);

            const homeExpanded = document.createElement('a');
            homeExpanded.href = "#";
            homeExpanded.className = "sidebar-item-expanded text-gray-300";
            homeExpanded.dataset.appCategory = 'home';
            homeExpanded.innerHTML = `<i data-lucide="layout-grid" class="w-5 h-5 flex-shrink-0"></i><span class="sidebar-text ml-4 font-medium">Главная</span>`;
            rightSidebarExpandedMenu.appendChild(homeExpanded);

            const archieCollapsed = document.createElement('a');
            archieCollapsed.href = "#";
            archieCollapsed.className = "sidebar-item text-gray-300 active"; // Archie активен по умолч.
            archieCollapsed.dataset.appCategory = 'archie';
            archieCollapsed.title = "Archie Чат";
            archieCollapsed.innerHTML = `<i data-lucide="brain" class="w-6 h-6"></i>`;
            rightSidebarCollapsedIcons.appendChild(archieCollapsed);

            const archieExpanded = document.createElement('a');
            archieExpanded.href = "#";
            archieExpanded.className = "sidebar-item-expanded text-gray-300 active";
            archieExpanded.dataset.appCategory = 'archie';
            archieExpanded.innerHTML = `<i data-lucide="brain" class="w-5 h-5 flex-shrink-0"></i><span class="sidebar-text ml-4 font-medium">Archie Чат</span>`;
            rightSidebarExpandedMenu.appendChild(archieExpanded);

            rightSidebarCollapsedIcons.innerHTML += '<hr class="border-t border-white/10 my-2">';
            rightSidebarExpandedMenu.innerHTML += '<hr class="border-t border-white/10 my-2">';

            dashboardData.smarthome_dashboard.tiles.forEach(tile => {
                const iconColorClass = getTailwindColorClass(tile.status_color);
                
                const collapsedItem = document.createElement('a');
                collapsedItem.href = "#";
                collapsedItem.className = `sidebar-item ${iconColorClass}`;
                collapsedItem.dataset.appCategory = tile.category;
                collapsedItem.title = tile.title;
                collapsedItem.innerHTML = `<i data-lucide="${tile.icon}" class="w-6 h-6"></i>`;
                rightSidebarCollapsedIcons.appendChild(collapsedItem);

                const expandedItem = document.createElement('a');
                expandedItem.href = "#";
                expandedItem.className = `sidebar-item-expanded text-gray-300`; // Текст всегда светлый
                expandedItem.dataset.appCategory = tile.category;
                expandedItem.innerHTML = `<i data-lucide="${tile.icon}" class="w-5 h-5 flex-shrink-0 ${iconColorClass}"></i><span class="sidebar-text ml-4 font-medium">${tile.title}</span>`;
                rightSidebarExpandedMenu.appendChild(expandedItem);
            });
        }

        // Рендеринг плиток Дашборда
        function renderDashboardGrid() {
            globalQuickActionsContainer.innerHTML = '';
            dashboardTilesContainer.innerHTML = '';
            
            if (dashboardData.smarthome_dashboard.quick_actions) {
                dashboardData.smarthome_dashboard.quick_actions.forEach(action => {
                    const button = document.createElement('button');
                    let buttonClasses = ['glass-button', 'px-4', 'py-2', 'rounded-lg', 'text-white', 'flex', 'items-center', 'gap-2', 'text-sm'];
                    if (action.style === 'primary') buttonClasses.push('btn-primary');
                    else if (action.style === 'secondary') buttonClasses.push('btn-secondary');
                    button.className = buttonClasses.join(' ');
                    button.innerHTML = `<i data-lucide="${action.icon}" class="w-5 h-5"></i><span>${action.text}</span>`;
                    button.onclick = () => alert(`Запрос: "${action.assistant_request}"`);
                    globalQuickActionsContainer.appendChild(button);
                });
            }

            dashboardData.smarthome_dashboard.tiles.forEach(tile => {
                const tileElement = document.createElement('div');
                tileElement.className = 'glass-tile rounded-2xl p-6 flex flex-col justify-between min-h-[260px]';
                const statusIconColorClass = getTailwindColorClass(tile.status_color);

                let devicesHtml = '';
                if (tile.devices && tile.devices.length > 0) {
                    devicesHtml = `<div class="mt-4 flex flex-wrap gap-3">
                        ${tile.devices.map(device => {
                            const deviceIconColorClass = getTailwindColorClass(device.color);
                            const deviceBgColorClass = device.variant === 'solid' ? getTailwindBgColorClass(device.color) : '';
                            return `
                                <div class="relative device-wrapper">
                                    <div class="device-icon ${device.variant === 'solid' ? 'variant-solid ' + deviceBgColorClass : 'variant-outline'}">
                                        <i data-lucide="${device.icon}" class="w-5 h-5 ${deviceIconColorClass}"></i>
                                    </div>
                                    <span class="device-tooltip text-xs">${device.tooltip}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>`;
                }

                let quickActionsHtml = '';
                if (tile.quick_actions && tile.quick_actions.length > 0) {
                    quickActionsHtml = `<div class="mt-6 flex flex-wrap gap-2">
                        ${tile.quick_actions.map(action => `
                            <button class="glass-button text-xs px-3 py-1.5 rounded-lg text-white">${action}</button>
                        `).join('')}
                    </div>`;
                }

                tileElement.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start">
                            <h2 class="text-xl font-semibold text-white">${tile.title}</h2>
                            <i data-lucide="${tile.icon}" class="w-6 h-6 ${statusIconColorClass}"></i>
                        </div>
                        <p class="text-sm text-gray-300 mt-1">${tile.subtitle}</p>
                        ${devicesHtml}
                    </div>
                    ${quickActionsHtml}
                `;
                dashboardTilesContainer.appendChild(tileElement);
            });
        }

        // --- Функции управления состоянием ---

        // Показать "Чат"
        function showChatView() {
            chatView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            updateSidebarActiveState('archie');
        }

        // Показать "Дашборд"
        function showDashboardView() {
            chatView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            updateSidebarActiveState('home');
        }

        // Обновить активное состояние кнопок "Archie" / "Home"
        function updateSidebarActiveState(activeCategory) {
            document.querySelectorAll('#right-sidebar a').forEach(el => {
                if (el.dataset.appCategory === activeCategory) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
        }

        // Свернуть/Развернуть ЛЕВУЮ панель
        function toggleLeftSidebar(forceCollapse = false) {
            isLeftSidebarExpanded = !isLeftSidebarExpanded;
            if (forceCollapse) isLeftSidebarExpanded = false;

            if (isLeftSidebarExpanded) {
                leftSidebar.classList.remove('w-20');
                leftSidebar.classList.add('w-72');
                mainContentArea.style.marginLeft = '18rem'; // 288px
                leftSidebarCollapsedIcons.classList.add('hidden');
                leftSidebarExpandedMenu.classList.remove('hidden');
                leftSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-left" class="w-6 h-6"></i>`;
                leftSidebarToggleBtn.title = "Свернуть панель";
                document.querySelectorAll('#left-sidebar .sidebar-text').forEach(el => el.style.opacity = '1');
            } else {
                leftSidebar.classList.add('w-20');
                leftSidebar.classList.remove('w-72');
                mainContentArea.style.marginLeft = '5rem'; // 80px
                leftSidebarCollapsedIcons.classList.remove('hidden');
                leftSidebarExpandedMenu.classList.add('hidden');
                leftSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-right" class="w-6 h-6"></i>`;
                leftSidebarToggleBtn.title = "Развернуть панель";
                document.querySelectorAll('#left-sidebar .sidebar-text').forEach(el => el.style.opacity = '0');
            }
            lucide.createIcons({
                nodes: [leftSidebarToggleBtn]
            });
        }
        
        // Свернуть/Развернуть ПРАВУЮ панель
        function toggleRightSidebar(forceCollapse = false) {
            isRightSidebarExpanded = !isRightSidebarExpanded;
            if (forceCollapse) isRightSidebarExpanded = false;

            if (isRightSidebarExpanded) {
                rightSidebar.classList.remove('w-20');
                rightSidebar.classList.add('w-72');
                mainContentArea.style.marginRight = '18rem'; // 288px
                rightSidebarCollapsedIcons.classList.add('hidden');
                rightSidebarExpandedMenu.classList.remove('hidden');
                rightSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-right" class="w-6 h-6"></i>`;
                rightSidebarToggleBtn.title = "Свернуть панель";
                document.querySelectorAll('#right-sidebar .sidebar-text').forEach(el => el.style.opacity = '1D');
            } else {
                rightSidebar.classList.add('w-20');
                rightSidebar.classList.remove('w-72');
                mainContentArea.style.marginRight = '5rem'; // 80px
                rightSidebarCollapsedIcons.classList.remove('hidden');
                rightSidebarExpandedMenu.classList.add('hidden');
                rightSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-left" class="w-6 h-6"></i>`;
                rightSidebarToggleBtn.title = "Развернуть панель";
                document.querySelectorAll('#right-sidebar .sidebar-text').forEach(el => el.style.opacity = '0');
            }
            lucide.createIcons({
                nodes: [rightSidebarToggleBtn]
            });
        }

        // --- Инициализация и обработчики событий ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Рендеринг всего
            renderRightSidebar();
            renderDashboardGrid();
            
            // 2. Инициализация иконок Lucide
            lucide.createIcons();

            // 3. Установка начального состояния
            showChatView(); // Показываем чат по умолчанию
            // Устанавливаем иконки для кнопок сворачивания
            leftSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-right" class="w-6 h-6"></i>`;
            rightSidebarToggleBtn.innerHTML = `<i data-lucide="chevron-left" class="w-6 h-6"></i>`;
            lucide.createIcons({ nodes: [leftSidebarToggleBtn, rightSidebarToggleBtn] });
            
            // Устанавливаем начальные отступы для контента
            mainContentArea.style.marginLeft = '5rem';
            mainContentArea.style.marginRight = '5rem';


            // 4. Обработчик клика на кнопку "Свернуть/Развернуть" (ЛЕВАЯ ПАНЕЛЬ)
            leftSidebarToggleBtn.addEventListener('click', () => toggleLeftSidebar());
            
            // 5. Обработчик клика на кнопку "Свернуть/Развернуть" (ПРАВАЯ ПАНЕЛЬ)
            rightSidebarToggleBtn.addEventListener('click', () => toggleRightSidebar());

            // 6. Обработчик кликов на элементы ПРАВОЙ ПАНЕЛИ (делегирование)
            rightSidebar.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (!link) return; 

                e.preventDefault(); 
                const category = link.dataset.appCategory;

                if (category === 'archie') {
                    showChatView();
                } else {
                    // 'home' или любая плитка
                    showDashboardView();
                    // Активируем кнопку 'home' в любом случае
                    updateSidebarActiveState('home');
                }

                // Сворачиваем, если была развернута
                if (isRightSidebarExpanded) {
                    toggleRightSidebar(true); // force collapse
                }
            });
            
            // 7. Обработчики для сворачивания панелей (Escape и Клик)
            
            // Клик на центральный контент
            mainContentArea.addEventListener('click', () => {
                if (isLeftSidebarExpanded) {
                    toggleLeftSidebar(true); // force collapse
                }
                if (isRightSidebarExpanded) {
                    toggleRightSidebar(true); // force collapse
                }
            });

            // Нажатие Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (isLeftSidebarExpanded) {
                        toggleLeftSidebar(true); // force collapse
                    }
                    if (isRightSidebarExpanded) {
                        toggleRightSidebar(true); // force collapse
                    }
                }
            });
        });

    </script>
</body>
</html>